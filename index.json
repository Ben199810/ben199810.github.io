[{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/","section":"bing-wei's Blog","summary":"","title":"bing-wei's Blog","type":"page"},{"content":" ä»‹ç´¹ # Helm æ˜¯ Kubernetes çš„ä¸€å€‹å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¯ä»¥ç”¨ä¾†ç°¡åŒ–æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²å’Œç®¡ç†ã€‚å®ƒä½¿ç”¨ç¨±ç‚º Chart çš„åŒ…è£æ ¼å¼ä¾†å®šç¾©æ‡‰ç”¨ç¨‹å¼çš„å„ç¨®è³‡æºï¼Œä¸¦æä¾›äº†ä¸€å€‹ç°¡å–®çš„å‘½ä»¤åˆ—ä»‹é¢ä¾†å®‰è£ã€å‡ç´šå’Œç®¡ç†é€™äº›æ‡‰ç”¨ç¨‹å¼ã€‚\nå‡½æ•¸ # Helm æä¾›äº†ä¸€äº›å…§å»ºå‡½æ•¸ï¼Œå¯ä»¥åœ¨ Chart çš„æ¨¡æ¿ä¸­ä½¿ç”¨ã€‚é€™äº›å‡½æ•¸å¯ä»¥ç”¨ä¾†è™•ç†å­—ä¸²ã€æ•¸å­—ã€æ—¥æœŸç­‰è³‡æ–™é¡å‹ï¼Œä¸¦æä¾›äº†ä¸€äº›å¸¸ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥å¹«åŠ©é–‹ç™¼è€…æ›´æ–¹ä¾¿åœ°ç·¨å¯«å’Œç¶­è­· Helm Chartã€‚\nquote # å°‡å­—ç¬¦ä¸²ä½¿ç”¨é›™å¼•è™ŸåŒ…è£¹èµ·ä¾†ã€‚\nâ­ï¸ sqoute è¡¨ç¤ºå–®å¼•è™Ÿã€‚\nuserName: User1 {{ .Values.userName | quote }} å¾—åˆ°çµæœ: \u0026ldquo;User1\u0026rdquo;\n{{ .Values.userName | squote }} å¾—åˆ°çµæœ: \u0026lsquo;User1\u0026rsquo;\nreplace # å­—ä¸²æ›¿æ›ã€‚\n\u0026#34;I Am Henry VIII\u0026#34; | replace \u0026#34; \u0026#34; \u0026#34;-\u0026#34; å¾—åˆ°çµæœ: I-Am-Henry-VIII\ndict # å‚³é key å’Œ value ä¾†å‰µå»ºä¸€å€‹ mapã€‚\n{{ $myDict := dict \u0026#34;key1\u0026#34; \u0026#34;value1\u0026#34; \u0026#34;key2\u0026#34; \u0026#34;value2\u0026#34; }} å¾—åˆ°çµæœ:\n{ \u0026#34;key1\u0026#34;: \u0026#34;value1\u0026#34;, \u0026#34;key2\u0026#34;: \u0026#34;value2\u0026#34; } fromYaml # å°‡ YAML å­—ä¸²è½‰æ›ç‚º Objectã€‚\nfilePath: yamls/person.yaml\nname: Bob age: 25 hobbies: - hiking - fishing - cooking {{- $person := .Files.Get \u0026#34;yamls/person.yaml\u0026#34; | fromYaml }} å¾—åˆ°çµæœ:\n{ \u0026#34;name\u0026#34;: \u0026#34;Bob\u0026#34;, \u0026#34;age\u0026#34;: 25, \u0026#34;hobbies\u0026#34;: [ \u0026#34;hiking\u0026#34;, \u0026#34;fishing\u0026#34;, \u0026#34;cooking\u0026#34; ] } merge, mergeOverwrite # âš ï¸ æ³¨æ„ç›®æ¨™ dst å„ªå…ˆ\ndst: default: default overwrite: me key: true src: overwrite: overwritten key: false {{- $newdict := merge .Values.dst .Values.src }} å¾—åˆ°çµæœ:\nnewdict: default: default overwrite: me key: true å¦‚æœè¦ä»¥ src ç‚ºå„ªå…ˆï¼Œå¯ä»¥ä½¿ç”¨ mergeOverwrite å‡½æ•¸ã€‚\n{{- $newdict := mergeOverwrite .Values.dst .Values.src }} å¾—åˆ°çµæœ:\nnewdict: default: default overwrite: overwritten key: false omit # é¡ä¼¼ pickï¼Œç”¨æ–¼å¾ map ä¸­æ’é™¤æŒ‡å®šçš„ keyã€‚\nvolumeMounts: - name: my-volume mountPath: /data claimName: my-pvc {{- range $mount := .volumeMounts }} {{- $cleanMount := omit $mount \u0026#34;claimName\u0026#34; }} {{- end }} å¾—åˆ°çµæœ:\nvolumeMounts: - name: my-volume mountPath: /data append # åœ¨å·²æœ‰é™£åˆ—ä¸­è¿½åŠ ä¸€å€‹å…ƒç´ ï¼Œå»ºç«‹ä¸€å€‹æ–°çš„é™£åˆ—ã€‚\nmyArray: - element1 - element2 - element3 {{- $newArray := append .Values.myArray \u0026#34;newElement\u0026#34; }} å¾—åˆ°çµæœ:\nnewArray: - element1 - element2 - element3 - newElement åƒè€ƒè³‡æ–™ # æ¨¡æ¿å‡½æ•°åˆ—è¡¨ ","date":"19 August 2025","externalUrl":null,"permalink":"/posts/helm/","section":"Posts","summary":"ä»‹ç´¹ # Helm æ˜¯ Kubernetes çš„ä¸€å€‹å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œå¯ä»¥ç”¨ä¾†ç°¡åŒ–æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²å’Œç®¡ç†ã€‚å®ƒä½¿ç”¨ç¨±ç‚º Chart çš„åŒ…è£æ ¼å¼ä¾†å®šç¾©æ‡‰ç”¨ç¨‹å¼çš„å„ç¨®è³‡æºï¼Œä¸¦æä¾›äº†ä¸€å€‹ç°¡å–®çš„å‘½ä»¤åˆ—ä»‹é¢ä¾†å®‰è£ã€å‡ç´šå’Œç®¡ç†é€™äº›æ‡‰ç”¨ç¨‹å¼ã€‚","title":"Helm","type":"posts"},{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/journals/","section":"Journals","summary":"","title":"Journals","type":"journals"},{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/tags/nginx/","section":"Tags","summary":"","title":"nginx","type":"tags"},{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/tags/redirect/","section":"Tags","summary":"","title":"redirect","type":"tags"},{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/tags/rewrite/","section":"Tags","summary":"","title":"rewrite","type":"tags"},{"content":" å‰è¨€ # è¿‘æœŸå…¬å¸ç¶²ç«™è¦ä¸‹æ¶èˆŠçš„å‰ç«¯ç¶²é æœå‹™ï¼Œingress èª¿æ•´å¾Œç«¯æœå‹™è·¯ç”±ã€‚\næ–°çš„æœå‹™ç¶²é ä½¿ç”¨ nginx rewrite ç¶²å€è·¯å¾‘ã€‚åœ¨æª¢æŸ¥éç¨‹ä¸­ç™¼ç¾åœ¨ç€è¦½å™¨é é¢æœƒç™¼ç¾æœ‰äº›å‰ç«¯éœæ…‹è³‡æºæ¸²æŸ“ä¸å‡ºä¾†ï¼Œå‘ˆç¾ç©ºç™½çš„é é¢ã€‚\nå¾Œä¾†ä½¿ç”¨ redirect æ–¹å¼ï¼Œå•é¡Œè§£æ±ºäº†ã€‚\næ‰€ä»¥æƒ³è¦è¨˜éŒ„ä¸€ä¸‹ rewrite å’Œ redirect çš„å·®ç•°ã€‚\nrewrite # nginx çš„ rewrite æ˜¯ä¸€ç¨®ç”¨æ–¼ä¿®æ”¹è«‹æ±‚ URL çš„è¦å‰‡æ©Ÿåˆ¶ï¼Œå¸¸ç”¨æ–¼ URL é‡å¯«ã€å°å‘ï¼ˆredirectï¼‰ã€éš±è—çœŸå¯¦è·¯å¾‘æˆ–åš SEO å„ªåŒ–ã€‚\nåŸºæœ¬èªæ³• # regex: æ­£å‰‡è¡¨é”å¼ï¼Œç”¨æ–¼åŒ¹é…åŸå§‹çš„è«‹æ±‚è·¯å¾‘ã€‚ replacement: è¦æ›¿æ›æˆçš„æ–°è·¯å¾‘æˆ–æ–°çš„ URLã€‚ flag: å¯é¸çš„æ¨™èªŒï¼Œæ§åˆ¶ rewrite è¡Œç‚ºçš„æ¨™èªŒï¼Œä¾‹å¦‚ permanentï¼ˆ301ï¼‰ã€redirectï¼ˆ302ï¼‰ã€breakã€last ç­‰ã€‚ rewrite regex replacement [flag]; åƒæ•¸ # last: åœæ­¢ rewriteï¼Œå°‡è«‹æ±‚é‡æ–°åœ¨ server æˆ– location å€å¡Šä¸­å°‹æ‰¾åŒ¹é…ï¼ˆä¸€èˆ¬ç”¨æ–¼ location å€å¡Šå…§ï¼‰ã€‚ break: åœæ­¢ rewriteï¼Œä½†ä¸å†é‡æ–°å°‹æ‰¾åŒ¹é…ï¼Œç›´æ¥åŸ·è¡Œå¾ŒçºŒé…ç½®ã€‚ redirect: è‡¨æ™‚é‡å®šå‘ï¼ˆ302ï¼‰ï¼Œå‘ŠçŸ¥ç€è¦½å™¨è«‹æ±‚æ–°çš„ URLã€‚ permanent: æ°¸ä¹…é‡å®šå‘ï¼ˆ301ï¼‰ã€‚ last è·Ÿ break å±¬æ–¼å…§éƒ¨é‡å®šå‘ï¼Œä¸æœƒæ”¹è®Šç€è¦½å™¨çš„ URLã€‚\nç•¶ç”¨æˆ¶è¨ªå• /old/path æ™‚ï¼Œå°‡å…¶é‡å¯«ç‚º /new/pathã€‚\nlocation / { rewrite ^/old/(.*)$ /new/$1 last; } redirect è·Ÿ permanent å±¬æ–¼å¤–éƒ¨é‡å®šå‘ï¼Œæœƒæ”¹è®Šç€è¦½å™¨çš„ URLã€‚\nç•¶ç”¨æˆ¶è¨ªå• /old/path æ™‚ï¼Œå°‡å…¶é‡å®šå‘åˆ° /new/pathã€‚\nlocation / { rewrite ^/old/(.*)$ /new/$1 redirect; } å•é¡Œåæ€ # åœ¨ä½¿ç”¨ rewrite çš„éç¨‹ä¸­ï¼Œç™¼ç¾æŸäº›éœæ…‹è³‡æºç„¡æ³•æ­£ç¢ºåŠ è¼‰ï¼Œé€™å¯èƒ½æ˜¯å› ç‚º rewrite æœƒåœ¨å…§éƒ¨è™•ç†è«‹æ±‚ï¼Œè€Œä¸æœƒæ”¹è®Šç€è¦½å™¨çš„ URLï¼Œå°è‡´æŸäº›è³‡æºçš„è«‹æ±‚è·¯å¾‘ä¸æ­£ç¢ºã€‚ç›¸å°è€Œè¨€ï¼Œredirect æœƒç›´æ¥å‘Šè¨´ç€è¦½å™¨æ–°çš„è«‹æ±‚è·¯å¾‘ï¼Œå¾è€Œé¿å…äº†é€™å€‹å•é¡Œã€‚\nåƒè€ƒ # ä»€éº¼æ˜¯ Nginx rewriteï¼Ÿè½‰å€çš„æ©Ÿåˆ¶ï¼Œèˆ‡ return 301 æˆ– redirect çš„å·®åˆ¥åœ¨å“ªï¼Ÿ ","date":"19 August 2025","externalUrl":null,"permalink":"/journals/nginx/rewrite-vs-redirect/","section":"Journals","summary":"å‰è¨€ # è¿‘æœŸå…¬å¸ç¶²ç«™è¦ä¸‹æ¶èˆŠçš„å‰ç«¯ç¶²é æœå‹™ï¼Œingress èª¿æ•´å¾Œç«¯æœå‹™è·¯ç”±ã€‚","title":"Rewrite vs Redirect","type":"journals"},{"content":"","date":"19 August 2025","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","date":"13 August 2025","externalUrl":null,"permalink":"/tags/job/","section":"Tags","summary":"","title":"job","type":"tags"},{"content":"","date":"13 August 2025","externalUrl":null,"permalink":"/tags/kubernetes/","section":"Tags","summary":"","title":"kubernetes","type":"tags"},{"content":" ä»‹ç´¹ # Job è¡¨ç¤ºä¸€æ¬¡æ€§çš„ä»»å‹™ï¼ŒåŸ·è¡Œå®Œæˆå¾Œå°±æœƒåœæ­¢ã€‚\nJob å¯ä»¥å»ºç«‹ä¸€å€‹æˆ–å¤šå€‹ Podï¼Œä¸¦å°‡ç¹¼çºŒé‡è©¦ Pod çš„åŸ·è¡Œï¼Œç›´åˆ°æŒ‡å®šæ•¸é‡çš„ Pod æˆåŠŸçµ‚æ­¢ã€‚\nç¯„ä¾‹ # åœ¨ç³»çµ±ä¸­éƒ¨ç½²æ–°çš„æœå‹™æ™‚ï¼Œå¯ä»¥ä½¿ç”¨ Job é€é command line å·¥å…·æˆ–è…³æœ¬ä¾†åŸ·è¡Œä¸€æ¬¡æ€§çš„ä»»å‹™ï¼Œä¾‹å¦‚è³‡æ–™åº«é·ç§»ã€æ‰¹æ¬¡è™•ç†ç­‰ã€‚\nbackoffLimit æŒ‡å®š Pod å¤±æ•—å¾Œé‡è©¦çš„æ¬¡æ•¸ã€‚å¦‚æœé‡è©¦æ¬¡æ•¸è¶…éæ­¤é™åˆ¶ï¼ŒJob å°‡è¢«æ¨™è¨˜ç‚ºå¤±æ•—ã€‚ restartPolicy Pod çš„å®¹å™¨å¯èƒ½å› ç‚ºå¤šç¨®ä¸åŒçš„åŸå› å¤±æ•ˆï¼Œ\u0026ldquo;OnFailure\u0026rdquo; ä½¿ Pod ç•™åœ¨ç›®å‰çš„ç¯€é»ä¸Šï¼Œä½†å®¹å™¨æœƒé‡æ–°é‹è¡Œã€‚ \u0026ldquo;Never\u0026rdquo;ï¼Œç•¶ Pod å¤±æ•—æ™‚ï¼ŒJob æ§åˆ¶å™¨æœƒå•Ÿå‹•æ–°çš„ Podã€‚ åªèƒ½ä½¿ç”¨ \u0026ldquo;Never\u0026rdquo; æˆ– \u0026ldquo;OnFailure\u0026rdquo;ã€‚ activeDeadlineSeconds æŒ‡å®š Job çš„æœ€å¤§åŸ·è¡Œæ™‚é–“ï¼ˆä»¥ç§’ç‚ºå–®ä½ï¼‰ã€‚å¦‚æœ Job åœ¨æ­¤æ™‚é–“å…§æœªå®Œæˆï¼Œå‰‡æœƒè¢«çµ‚æ­¢ã€‚ activeDeadlineSeconds çš„å„ªå…ˆæ¬Šé«˜æ–¼ backoffLimitã€‚ ttlSecondsAfterFinished Job å®Œæˆå¾Œé è¨­æ˜¯ä¸æœƒè¢«æ¸…ç†çš„ï¼Œå¯ä»¥è¨­å®šæ­¤åƒæ•¸ä¾†æŒ‡å®š Job å®Œæˆå¾Œä¿ç•™çš„æ™‚é–“ï¼ˆä»¥ç§’ç‚ºå–®ä½ï¼‰ã€‚ç•¶æ™‚é–“åˆ°é”å¾Œï¼ŒJob å°‡è¢«è‡ªå‹•æ¸…ç†ã€‚ apiVersion: batch/v1 kind: Job metadata: name: example-job spec: ttlSecondsAfterFinished: 60 activeDeadlineSeconds: 30 template: spec: containers: - name: example image: example-image command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo Hello, Kubernetes! \u0026amp;\u0026amp; sleep 30\u0026#34;] restartPolicy: Never backoffLimit: 4 åƒè€ƒè³‡æ–™ # Kubernetes æ–‡æª”/æ¦‚å¿µ/å·¥ä½œè² è¼‰/å·¥ä½œè² è¼‰ç®¡ç†/Job ","date":"13 August 2025","externalUrl":null,"permalink":"/posts/k8s/job/","section":"Posts","summary":"ä»‹ç´¹ # Job è¡¨ç¤ºä¸€æ¬¡æ€§çš„ä»»å‹™ï¼ŒåŸ·è¡Œå®Œæˆå¾Œå°±æœƒåœæ­¢ã€‚","title":"Kubernetes Job","type":"posts"},{"content":"","date":"18 July 2025","externalUrl":null,"permalink":"/tags/datadog/","section":"Tags","summary":"","title":"datadog","type":"tags"},{"content":" äº‹ä»¶éç¨‹ # è¿‘æœŸå…¬å¸åŒä»åæ‡‰ Datadog åœæ­¢æ”¶é›† Kafka çš„ metricsï¼Œå› æ­¤é€²è¡Œèª¿æŸ¥çš„éç¨‹ç´€éŒ„ä¸‹ä¾†ã€‚æœªä¾†è‹¥æœ‰åŒæ¨£çš„å•é¡Œï¼Œå¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç« ã€‚\næ¶æ§‹åœ– # å…ˆä¾†äº†è§£ Kafka Metrics æ˜¯å¦‚ä½•è¢« Datadog æ”¶é›†çš„ã€‚\ndatadog agent æœƒéƒ¨ç½²åœ¨ Kubernetes ç’°å¢ƒä¸­ï¼Œä¸”åœ¨ node ä¸­é‹è¡Œã€‚å®ƒæœƒæ”¶é›† Pod æœå‹™çš„ metricsï¼Œä¹Ÿæœƒæ”¶é›† Kafka çš„ metricsã€‚\nè¦æ³¨æ„çš„æ˜¯ Kafka çš„ VM ä¸¦æ²’æœ‰éƒ¨ç½² Datadog Agentï¼Œè€Œæ˜¯é€é Kubernetes çš„ Datadog Agent ä¾†æ”¶é›† Kafka çš„ metricsã€‚\né€™éº¼åšçš„åŸå› æ˜¯ Datadog Agent æ”¶è²»æ˜¯æœƒä¾ç…§ä½¿ç”¨çš„ Agent æ•¸é‡è¨ˆç®—çš„ï¼Œå¯ä»¥æ¸›å°‘è²»ç”¨çš„ç”¢ç”Ÿã€‚\nflowchart LR subgraph kubernetes subgraph node datadog[Datadog Agent] pod[Pod] end end subgraph GCE kafka[Kafka] end datadog --\u003e|æ”¶é›†| kafka datadog --\u003e|æ”¶é›†| pod å•é¡Œèª¿æŸ¥ # ç¢ºèªç¶²è·¯é€£ç·šæ˜¯å¦ç•°å¸¸\né¦–å…ˆç¢ºèª Datadog Agent æ˜¯å¦èƒ½å¤ é€£ç·šåˆ° Kafka çš„ metrics endpointã€‚è¦æ€éº¼ç¢ºèª kafka çš„ metrics endpoint æ˜¯ä»€éº¼å‘¢ï¼Ÿ\nå¯ä»¥åœ¨ Kafka çš„é…ç½®æª”ä¸­æ‰¾åˆ°ï¼Œåœ¨é…ç½®ç›£æ§ç³»çµ±æ™‚ï¼Œå¦‚æœæ¡ç”¨ JMX Exporter çš„æ–¹å¼ï¼Œå‰‡å¯ä»¥åœ¨ /etc/systemd/system/kafka.service ä¸­æ‰¾åˆ°ã€‚\n-Dcom.sun.management.jmxremote.port é€™å€‹åƒæ•¸æŒ‡å®šäº† JVM çš„ JMX ç›£æ§ç«¯å£ï¼Œé€šå¸¸æ˜¯ 9134ã€‚\n-Dcom.sun.management.jmxremote.rmi.port é€™å€‹åƒæ•¸æŒ‡å®šäº† RMI (é ç«¯æ–¹æ³•å‘¼å«) çš„ç«¯å£ã€‚é è¨­æƒ…æ³ä¸‹ï¼ŒJMX æœƒå‹•æ…‹é¸æ“‡ä¸€å€‹ RMI ç«¯å£ï¼Œåœ¨é›²ç«¯æˆ–é˜²ç«ç‰†ç’°å¢ƒä¸‹ï¼Œå‹•æ…‹ç«¯å£æœƒå°è‡´é›£ä»¥é–‹æ”¾é˜²ç«ç‰†è¦å‰‡ã€‚\nå°‡ jmxremote.port å’Œ jmxremote.rmi.port è¨­å®šç›¸åŒï¼Œå¯ç¢ºä¿ JMX ç›£æ§åªå•Ÿç”¨æ­¤é€£æ¥åŸ ï¼ˆæ­¤è™•ç‚º 9134ï¼‰ä¾‹ï¼Œé˜²ç«ç‰†è¨­å®šå’Œå®‰å…¨ç›£æ§ç®¡ã€‚\n[Service] Environment=\u0026#34;KAFKA_JMX_OPTS=-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=9134 -Djava.rmi.server.hostname=10.106.10.151\u0026#34; æª¢æŸ¥ VM ç›£æ§ç«¯å£æ˜¯å¦é–‹å•Ÿ\nnetstat -an | grep 9134 # æˆ– lsof -i :9134 æª¢æŸ¥ Kubernetes åˆ° Kafka çš„é€£ç·šæ˜¯å¦ç•°å¸¸\nåœ¨ Kubernetes ç’°å¢ƒä¸­ï¼Œå»ºç«‹ä¸€å€‹ Podï¼Œä¸¦ä½¿ç”¨ curl æˆ– telnet æ¸¬è©¦é€£ç·šåˆ° Kafka çš„ JMX ç«¯å£ã€‚\napiVersion: v1 kind: Pod metadata: name: test-kafka-JMX-connection spec: containers: - name: test-container image: maven:3.8-openjdk-11 command: - /bin/sh - -c args: - | echo \u0026#34;Downloading jmxterm...\u0026#34; curl -L -s -o /tmp/jmxterm.jar https://github.com/jiaqi/jmxterm/releases/download/v1.0.2/jmxterm-1.0.2-uber.jar; echo \u0026#34;Testing JMX connection to Kafka...\u0026#34; get -b kafka.server:type=KafkaServer,name=BrokerState Value | java -jar /tmp/jmxterm.jar -n -l ${KAFKA_JMX_HOST}:9134; echo \u0026#34;JMX connection test completed.\u0026#34; resources: limits: memory: \u0026#34;512Mi\u0026#34; cpu: \u0026#34;500m\u0026#34; requests: memory: \u0026#34;256Mi\u0026#34; cpu: \u0026#34;250m\u0026#34; ç¢ºèª Datadog Agent çš„é…ç½®\nç¢ºèª Datadog Agent çš„é…ç½®æª”ä¸­æ˜¯å¦æœ‰æ­£ç¢ºè¨­å®š Kafka çš„ JMX ç«¯å£ã€‚é€šå¸¸åœ¨ /etc/datadog-agent/conf.d/kafka.d/conf.yaml ä¸­ã€‚\ninit_config: {} instances: - host: \u0026lt;kafka-host\u0026gt; port: 9134 tags: - kafka Datadog Support å»ºè­°\nSupport åœ˜éšŠå»ºè­°å¯ä»¥ä½¿ç”¨ flare å‚³éè³‡è¨Šåˆ°æ¡ˆä»¶å–®ä¸Šï¼Œæœ‰åŠ©æ–¼æ’æŸ¥å•é¡Œã€‚\nåœ¨ kafka integration ä¸­ï¼Œè¨­ç½® checke runner (cluster_check: true) ã€‚å› æ­¤å¯ä»¥ flare cluster agent çš„è³‡è¨Šã€‚\nkubectl exec -it \u0026lt;NAMESPACE\u0026gt; -it \u0026lt;CLUSTER_POD_NAME\u0026gt; -- agent flare \u0026lt;æ¡ˆä»¶ç·¨è™Ÿ\u0026gt; æª¢æŸ¥ cluster check runnersã€‚\nkubectl exec -n \u0026lt;NAMESPACE\u0026gt; -it \u0026lt;CLUSTER_POD_NAME\u0026gt; -- agent clusterchecks Datadog Support å›é¥‹\nåœ¨æä¾›ä¸Šè¿°çš„è³‡è¨Šä¹‹å¾Œï¼ŒSupport åœ˜éšŠå›è¦†åœ¨ flare (status.log) ä¸­ç™¼ç¾äº† kafka instance æª¢æŸ¥çš„ç‹€æ…‹ã€‚\n========= JMX Fetch ========= Information ================== runtime_version : 11.0.23 version : 0.49.1 Initialized checks ================== kafka - instance_name: kafka-02 metric_count: 346 service_check_count: 0 message: \u0026lt;no value\u0026gt; status: OK - instance_name: kafka-01 metric_count: 350 service_check_count: 0 message: Number of returned metrics is too high for instance: kafka-01. Please read http://docs.datadoghq.com/integrations/java/ or get in touch with Datadog Support for more details. Truncating to 350 metrics. status: WARNING - instance_name: kafka-03 metric_count: 350 service_check_count: 0 message: Number of returned metrics is too high for instance: kafka-03. Please read http://docs.datadoghq.com/integrations/java/ or get in touch with Datadog Support for more details. Truncating to 350 metrics. status: WARNING kafka-01 å’Œ kafka-03 å‡ºç¾ä»¥ä¸‹è­¦å‘Šè¨Šæ¯ï¼š\nNumber of returned metrics is too high for instance: kafka-03. Please read http://docs.datadoghq.com/integrations/java/ or get in touch with Datadog Support for more details. Truncating to 350 metrics. Support åœ˜éšŠå»ºè­°ç”±æ–¼å‚³å›çš„æŒ‡æ¨™æ•¸é‡å¤ªé«˜ï¼Œå³é«˜æ–¼é è¨­å€¼ 350ã€‚å› æ­¤ï¼Œè¦è§£æ±ºæ­¤å•é¡Œï¼Œæ‚¨å¯ä»¥æ–°å¢ max_returned_metrics åƒæ•¸ä¸¦å°‡å€¼è¨­ç‚ºé«˜æ–¼ 350ã€‚\nä¿®æ­£ç¯„ä¾‹èˆ‡é©—è­‰ # åœ¨ values.yaml ä¸­æˆ‘å€‘éœ€è¦æ–°å¢ max_returned_metrics åƒæ•¸ï¼Œä¸¦å°‡å…¶å€¼è¨­ç‚ºéœ€è¦çš„å€¼ä¸”å¤§æ–¼é è¨­å€¼ã€‚\nclusterAgent: confd: kafka.yaml: |- cluster_check: true init_config: is_jmx: true collect_default_metrics: true new_gc_metrics: true instances: - host: \u0026lt;kafka-host\u0026gt; port: 9134 name: kafka-01 max_returned_metrics: 500 # æ–°å¢æ­¤è¡Œ ç„¶å¾Œé‡æ–°éƒ¨ç½² Datadog Agentã€‚\nä½¿ç”¨ agent status æª¢æŸ¥ Kafka çš„ metrics count æ˜¯å¦å·²ç¶“è¶…é 350 ä¸” status å¾ WARNING è®Šç‚º OKã€‚\nå› ç‚º agent æœ‰å¾ˆå¤šå°ï¼Œæ‰€ä»¥ä½¿ç”¨è…³æœ¬çš„æ–¹å¼å»æ‰¾åˆ°æ”¶é›† Kafka VM Metrics çš„ agentã€‚\n#!/bin/bash echo \u0026#34;Found pods:\u0026#34; kubectl get pods -n datadog -o custom-columns=NAME:.metadata.name --no-headers | grep -v cluster read -p \u0026#34;æœå°‹é—œéµå­—ï¼š\u0026#34; SEARCH_KEYWORD PODS=$(kubectl get pods -n datadog -o custom-columns=NAME:.metadata.name --no-headers | grep -v cluster) IFS=$\u0026#39;\\n\u0026#39; read -d \u0026#39;\u0026#39; -r -a POD_ARRAY \u0026lt;\u0026lt;\u0026lt; \u0026#34;$PODS\u0026#34; for POD in \u0026#34;${POD_ARRAY[@]}\u0026#34;; do echo \u0026#34;Checking status of pod: $POD\u0026#34; kubectl exec -n datadog $POD -c agent -- agent status | grep \u0026#34;$SEARCH_KEYWORD\u0026#34; if [ $? -ne 0 ]; then echo \u0026#34;No kafka-common found in $POD\u0026#34; fi echo \u0026#34;----------------------------------------\u0026#34; done echo \u0026#34;Finished checking all pods.\u0026#34; æ‰¾åˆ°å°æ‡‰çš„ agent ä¹‹å¾Œï¼Œä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æª¢æŸ¥ Kafka çš„ metrics countã€‚\nå¯ä»¥çœ‹åˆ° kafka çš„ metrics count å·²ç¶“è¶…é 350 ä¸” status å¾ WARNING è®Šç‚º OKã€‚\n========= JMX Fetch ========= Information ================== runtime_version : 11.0.23 version : 0.49.1 Initialized checks ================== kafka - instance_name: kafka-02 metric_count: 346 service_check_count: 0 message: \u0026lt;no value\u0026gt; status: OK - instance_name: kafka-01 metric_count: 476 service_check_count: 0 message: \u0026lt;no value\u0026gt; status: OK - instance_name: kafka-03 metric_count: 443 service_check_count: 0 message: \u0026lt;no value\u0026gt; status: OK Failed checks ============= no checks å•é¡Œåæ€ # é€™æ¬¡å•é¡Œçš„æ ¹æœ¬åŸå› æ˜¯ Kafka çš„ metrics æ•¸é‡è¶…éäº† Datadog çš„é è¨­é™åˆ¶ï¼Œå°è‡´éƒ¨åˆ† metrics ç„¡æ³•è¢«æ”¶é›†ã€‚\nå¦‚æœä¸æé«˜ max_returned_metrics çš„ä¸Šé™å€¼ï¼Œæœ‰æ–¹æ³•å¯ä»¥é™ä½ metric_count çš„æ•¸é‡å—ï¼Ÿ\nsupport æä¾›ä»¥ä¸‹çš„æ–¹å¼æ¸›å°‘ metric_count çš„æ•¸é‡ï¼š\nmetric_count å€¼æ˜¯æ¯å€‹ instance çš„ Datadog æŒ‡æ¨™ç¸½æ•¸ã€‚\nå°æ–¼ Kafka integrationï¼ŒDatadog æŒ‡æ¨™æ˜¯è—‰åŠ©æ­¤æ–‡ä»¶ metrics.yaml ï¼ˆ é€£çµ ï¼‰ ç”Ÿæˆçš„ï¼Œå¦‚æœé›†æˆæ‰¾åˆ°å…·æœ‰åŒ¹é…çš„ domainã€bean å’Œ attribute çš„ jmx æŒ‡æ¨™ï¼Œå®ƒå°‡ç”Ÿæˆ Datadog æŒ‡æ¨™ã€‚\nå¦‚æœæ‚¨æƒ³è¦æ¸›å°‘ metric_count å€¼ï¼Œæ‚¨å¯ä»¥å°‡æ­¤åƒæ•¸è®Šæ›´ç‚º collect_default_metrics ç‚º false ï¼Œé€™æ¨£å°±ä¸æœƒä½¿ç”¨ metrics.yaml ï¼Œç„¶å¾Œå»ºç«‹æ‚¨è‡ªå·±çš„é…ç½®ä»¥å°ˆé–€åŒ¹é…ä»»ä½• jmx æŒ‡æ¨™ä»¥å¾æ­¤ç¯„ä¾‹ï¼ˆ é€£çµ ï¼‰ ç”¢ç”Ÿ Datdog æŒ‡æ¨™ã€‚\nåƒè€ƒè³‡æ–™ # èŠèŠ Kafka å¦‚ä½•åŸºæ–¼ JMX ç›£æ§ ","date":"18 July 2025","externalUrl":null,"permalink":"/journals/datadog/datadog-stopped-collecting-kafka-metrics/","section":"Journals","summary":"äº‹ä»¶éç¨‹ # è¿‘æœŸå…¬å¸åŒä»åæ‡‰ Datadog åœæ­¢æ”¶é›† Kafka çš„ metricsï¼Œå› æ­¤é€²è¡Œèª¿æŸ¥çš„éç¨‹ç´€éŒ„ä¸‹ä¾†ã€‚æœªä¾†è‹¥æœ‰åŒæ¨£çš„å•é¡Œï¼Œå¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç« ã€‚","title":"Datadog Stopped Collecting Kafka Metrics","type":"journals"},{"content":"","date":"18 July 2025","externalUrl":null,"permalink":"/tags/kafka/","section":"Tags","summary":"","title":"kafka","type":"tags"},{"content":"","date":"18 July 2025","externalUrl":null,"permalink":"/tags/metrics/","section":"Tags","summary":"","title":"metrics","type":"tags"},{"content":"","date":"14 July 2025","externalUrl":null,"permalink":"/tags/lint/","section":"Tags","summary":"","title":"lint","type":"tags"},{"content":"","date":"14 July 2025","externalUrl":null,"permalink":"/tags/yaml/","section":"Tags","summary":"","title":"yaml","type":"tags"},{"content":" ä»‹ç´¹ # yamllint ä¸åƒ…æª¢æŸ¥èªæ³•çš„æœ‰æ•ˆæ€§ï¼Œé‚„æª¢æŸ¥è«¸å¦‚éµé‡è¤‡ä¹‹é¡çš„ç•°å¸¸æƒ…æ³ä»¥åŠè«¸å¦‚è¡Œé•·åº¦ã€å°¾éš¨ç©ºæ ¼ã€ç¸®æ’ç­‰å¤–è§€å•é¡Œã€‚\næœ‰æ™‚å€™å°¾éš¨ç©ºæ ¼å¯èƒ½æœƒå°è‡´ YAML æ–‡ä»¶è§£æéŒ¯èª¤ï¼Œé€™åœ¨è™•ç†å¤§å‹é…ç½®æ–‡ä»¶æ™‚å°¤å…¶é‡è¦ã€‚\nå°æ–¼æ™‚å¸¸ç¶­è­·å¤§é‡ YAML æ–‡ä»¶çš„é–‹ç™¼è€…ä¾†èªªæ˜¯ä¸€å€‹éå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚\nå®‰è£ # brew install yamllint ä½¿ç”¨ # ç•¶å‰çš„ç›®éŒ„ä¸‹å°æ‰€æœ‰ YAML æ–‡ä»¶é€²è¡Œæª¢æŸ¥ã€‚\nå¦‚æœæœ‰ .yamllint é…ç½®æ–‡ä»¶ï¼Œé è¨­æœƒè‡ªå‹•è¼‰å…¥æ–‡ä»¶çš„é…ç½®ã€‚\nyamllint . é è¨­ # yamllint æœ‰ä¸€äº›é è¨­æª”æ¡ˆé…ç½®ã€‚\n--- yaml-files: # é€™å€‹é…ç½®æŒ‡å®šäº†è¦æª¢æŸ¥çš„ YAML æ–‡ä»¶é¡å‹ã€‚ - \u0026#39;*.yaml\u0026#39; - \u0026#39;*.yml\u0026#39; - \u0026#39;.yamllint\u0026#39; rules: anchors: enable braces: enable brackets: enable colons: enable commas: enable comments: level: warning comments-indentation: level: warning document-end: disable document-start: level: warning empty-lines: enable empty-values: disable float-values: disable hyphens: enable indentation: enable key-duplicates: enable key-ordering: disable line-length: enable new-line-at-end-of-file: enable new-lines: enable octal-values: disable quoted-strings: disable trailing-spaces: enable truthy: level: warning yamllint é‚„æœ‰å¦ä¸€å€‹é å®šç¾©çš„é…ç½®å« relaxedï¼Œé¡§åæ€ç¾©å°±æ˜¯æ”¾å¯¬æª¢æŸ¥ï¼Œå¯¬å®¹æ€§æ›´é«˜ã€‚\nyamllint -d relaxed file.yml é…ç½® # å¦‚æœéœ€è¦è‡ªå®šç¾©é…ç½®ï¼Œå¯ä»¥ä¸å¿…å…¨éƒ¨çš„é…ç½®éƒ½é‡æ–°å®šç¾©ä¸€æ¬¡ã€‚ä½¿ç”¨ extends é—œéµå­—æ“´å±•é è¨­é…ç½®ã€‚\nextends: default line-length: max: 80 level: warning å¿½ç•¥æª¢æŸ¥ # å¦‚æœåƒ helm template é›–ç„¶æ˜¯ YAML æ–‡ä»¶ï¼Œä½†æ˜¯ä½¿ç”¨ go template èªæ³•ï¼Œé€™æ™‚å€™å¯ä»¥ä½¿ç”¨ ignore ä¾†å¿½ç•¥æª¢æŸ¥ã€‚\nignore: - *.template.yaml åƒæ•¸è¦å‰‡ # anchersï¼šæª¢æŸ¥éŒ¨é»å’Œåˆ¥åçš„ä½¿ç”¨æƒ…æ³ã€‚ bracesï¼šæ§åˆ¶ Flow Mapping ä¸­å¤§æ‹¬è™Ÿçš„ä½¿ç”¨ã€‚ bracketsï¼šæ§åˆ¶ Flow Sequence ä¸­æ–¹æ‹¬è™Ÿçš„ä½¿ç”¨ã€‚ document-startï¼šæª¢æŸ¥æ–‡ä»¶é–‹é ­æ˜¯å¦æœ‰ ---ã€‚ rules: anchers: # å›å ±é‡è¤‡çš„éŒ¨é»è·Ÿæœªè²æ˜çš„éŒ¨é»ã€‚ forbid-undeclared-aliases: true # æœªè²æ˜ forbid-duplicated-anchors: false # é‡è¤‡ forbid-unused-anchors: false # æœªä½¿ç”¨ braces: # æ§åˆ¶ Flow Mapping (å…§è¡Œå‹çš„éµå€¼å°) ä¸­å¤§æ‹¬è™Ÿçš„ä½¿ç”¨ã€‚ forbid: false # æ˜¯å¦ç¦æ­¢ä½¿ç”¨ Flow Mapping min-spaces-inside: 0 # å¤§æ‹¬è™Ÿå…§éƒ¨çš„æœ€å°ç©ºæ ¼æ•¸ max-spaces-inside: 0 # å¤§æ‹¬è™Ÿå…§éƒ¨çš„æœ€å¤§ç©ºæ ¼æ•¸ min-spaces-inside-empty: -1 # ç©ºå¤§æ‹¬è™Ÿå…§éƒ¨çš„æœ€å°ç©ºæ ¼æ•¸ max-spaces-inside-empty: -1 # ç©ºå¤§æ‹¬è™Ÿå…§éƒ¨çš„æœ€å¤§ç©ºæ ¼æ•¸ brackets: # æ§åˆ¶ Flow Sequence (å…§è¡Œå‹çš„åˆ—è¡¨) ä¸­æ–¹æ‹¬è™Ÿ forbid: false # æ˜¯å¦ç¦æ­¢ä½¿ç”¨ Flow Sequence min-spaces-inside: 0 max-spaces-inside: 0 min-spaces-inside-empty: -1 max-spaces-inside-empty: -1 document-start: # æª¢æŸ¥æ–‡ä»¶é–‹é ­æ˜¯å¦æœ‰ `---`ã€‚ present: true # æ˜¯å¦éœ€è¦ `---` é–‹é ­ empty-linesï¼šæª¢æŸ¥ç©ºè¡Œçš„ä½¿ç”¨æƒ…æ³ã€‚ ç‚ºäº†è¦ç¯„åœ˜éšŠçš„ä»£ç¢¼é¢¨æ ¼ï¼Œå¯ä»¥è¨­å®šç©ºè¡Œçš„æ•¸é‡ã€‚å¾ˆå¸¸æœ‰äººæœƒä½¿ç”¨éå¤šçš„ç©ºè¡Œä¾†åˆ†éš”ä»£ç¢¼å¡Šï¼Œé€™æ¨£æœƒå°è‡´ä»£ç¢¼ä¸æ˜“é–±è®€ã€‚\nrules: empty-lines: max: 1 # å…è¨±çš„æœ€å¤§ç©ºè¡Œæ•¸ example\npass\n- foo: - 1 - 2 - bar: [3, 4] fail\n- foo: - 1 - 2 - bar: [3, 4] indentationï¼šæ§åˆ¶ç¸®æ’çš„ä½¿ç”¨æƒ…æ³ã€‚\nYaml çš„æ–‡ä»¶ç¸®é€²éå¸¸éˆæ´»ï¼Œä½†ç‚ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œé€šå¸¸æœƒä½¿ç”¨å…©å€‹ç©ºæ ¼æˆ–å››å€‹ç©ºæ ¼ä¾†ç¸®æ’ã€‚ç‚ºäº†æ›´å¥½çš„è¦ç¯„åœ˜éšŠçš„ä»£ç¢¼é¢¨æ ¼ï¼Œå¯ä»¥è¨­å®šç¸®æ’çš„ç©ºæ ¼æ•¸é‡ã€‚\nindent-sequences æ±ºå®šå°æ–¼åºåˆ— (array) çš„ç¸®æ’æ–¹å¼ï¼Œæä¾›å››ç¨®é¸æ“‡ï¼štrueã€falseã€consistent å’Œ whateverã€‚\nconsistent è¦æ±‚æ‰€æœ‰çš„åºåˆ—éƒ½ä½¿ç”¨ç›¸åŒçš„ç¸®æ’æ–¹å¼ï¼Œå¯ä»¥å…¨éƒ¨éƒ½ç¸®æ’æˆ–è€…å…¨éƒ¨éƒ½ä¸ç¸®æ’ã€‚\nwhatever å‰‡å…è¨±åºåˆ—çš„ç¸®æ’æ–¹å¼ä¸ä¸€è‡´ï¼Œé€™æ¨£å¯ä»¥æ›´éˆæ´»åœ°è™•ç†ä¸åŒçš„æƒ…æ³ã€‚\nrules: indentation: spaces: 2 # ç¸®æ’ä½¿ç”¨çš„ç©ºæ ¼æ•¸é‡ indent-sequences: true example pass\nhistory: - name: Unix date: 1969 - name: Linux date: 1991 é€²éšç”¨æ³• # éŒ¨é»å’Œåˆ¥å # YAML ä¸­çš„éŒ¨é» (anchors) å’Œåˆ¥å (aliases) ç”¨æ–¼é‡è¤‡ä½¿ç”¨ç›¸åŒçš„å€¼æˆ–çµæ§‹ï¼Œé€™æ¨£å¯ä»¥æ¸›å°‘é‡è¤‡ä»£ç¢¼ä¸¦æé«˜å¯è®€æ€§ã€‚\nä»¥ä¸‹é¢çš„ YAML ç‚ºä¾‹ï¼š\nå…ˆä½¿ç”¨ \u0026amp; å®šç¾©ä¸€å€‹éŒ¨é»ï¼Œç„¶å¾Œä½¿ç”¨ * ä¾†å¼•ç”¨é€™å€‹éŒ¨é»ã€‚\ndefault_config éŒ¨é»è¨­å®šäº† key1 å’Œ key2 æœƒé‡è¤‡ä½¿ç”¨åˆ°çš„è¨­å®šå€¼ã€‚æ¥è‘—ä½¿ç”¨ \u0026lt;\u0026lt; ä¾†åˆä½µé€™å€‹éŒ¨é»åˆ°å…¶ä»–é…ç½®ä¸­ã€‚\n\u0026amp;default_config: key1: value1 key2: value2 my_config: \u0026lt;\u0026lt;: *default_config # ä½¿ç”¨åˆ¥åä¾†å¼•ç”¨éŒ¨é» key3: value3 another_config: \u0026lt;\u0026lt;: *default_config # å†æ¬¡ä½¿ç”¨åŒä¸€å€‹éŒ¨é» key4: value4 Flow Mapping # Flow Mapping æ˜¯ YAML ä¸­ä¸€ç¨®ä½¿ç”¨å¤§æ‹¬è™Ÿ {} ä¾†è¡¨ç¤ºéµå€¼å°çš„æ–¹å¼ã€‚é€™ç¨®æ–¹å¼é€šå¸¸ç”¨æ–¼ç°¡åŒ–è¡¨ç¤ºå¤šå€‹éµå€¼å°çš„æƒ…æ³ã€‚\nä¸€èˆ¬ä¾†èªªï¼Œæœ€å¸¸è¦‹ã€æ˜“è®€çš„å¯«æ³•æ˜¯ Block Mappingï¼Œå³ä½¿ç”¨ç¸®æ’çš„æ–¹å¼ä¾†è¡¨ç¤ºå±¤ç´šé—œä¿‚ã€‚\n# Block Mapping key1: subkey1: value1 subkey2: value2 # Flow Mapping key1: {subkey1: value1, subkey2: value2} åƒè€ƒè³‡æ–™ # yamllint æ–‡æª” ç”¨ YAML anchors \u0026amp; aliases å¯«å‡ºæ›´å¥½ç¶­è­·çš„ docker compose file ","date":"14 July 2025","externalUrl":null,"permalink":"/posts/tool/yamllint/","section":"Posts","summary":"ä»‹ç´¹ # yamllint ä¸åƒ…æª¢æŸ¥èªæ³•çš„æœ‰æ•ˆæ€§ï¼Œé‚„æª¢æŸ¥è«¸å¦‚éµé‡è¤‡ä¹‹é¡çš„ç•°å¸¸æƒ…æ³ä»¥åŠè«¸å¦‚è¡Œé•·åº¦ã€å°¾éš¨ç©ºæ ¼ã€ç¸®æ’ç­‰å¤–è§€å•é¡Œã€‚","title":"Yamllint","type":"posts"},{"content":"","date":"2 July 2025","externalUrl":null,"permalink":"/tags/autoscaling/","section":"Tags","summary":"","title":"autoscaling","type":"tags"},{"content":"","date":"2 July 2025","externalUrl":null,"permalink":"/tags/helm/","section":"Tags","summary":"","title":"helm","type":"tags"},{"content":"æœ€è¿‘åœ¨å‡ç´š helm release æ™‚é‡åˆ°äº†ä¸€å€‹éŒ¯èª¤ï¼Œæç¤º \u0026ldquo;no matches for kind HorizontalPodAutoscaler in version autoscaling/v2beta2\u0026rdquo;ã€‚\nåŸå› æ˜¯å› ç‚º Kubernetes çš„ API ç‰ˆæœ¬è®Šæ›´ï¼Œå°è‡´èˆŠçš„è³‡æºå®šç¾©ä¸å†åŒ¹é…æ–°çš„ API ç‰ˆæœ¬ã€‚\nè§£æ±ºæ–¹æ³• # å› ç‚ºæ˜¯æ­£å¼ç«™ç’°å¢ƒçš„ log æœå‹™ï¼Œlog çš„æ”¶é›†å° RD åœ¨æ’æŸ¥å•é¡Œæ™‚éå¸¸é‡è¦ã€‚å¦‚æœåˆªé™¤å¾Œå†é‡æ–°éƒ¨ç½²ï¼Œæœƒå°è‡´ log çš„ä¸Ÿå¤±ã€‚\nHelm3 æ”¯æ´ä¸€æ¬¾æ’ä»¶å·¥å…· mapkubeapisï¼Œå¯ä»¥å°‡æœ‰ä½¿ç”¨å·²æ£„ç”¨æˆ–å·²åˆªé™¤çš„ API çš„ Helm Release metadata æ›´æ–°ç‚ºæœ‰å—æ”¯æ´çš„ APIã€‚\nhelm mapkubeapis -n kube_namespace releaseName åƒè€ƒè³‡æ–™ # Helm upgrade failure due to deprecated or removed Kubernetes API ","date":"2 July 2025","externalUrl":null,"permalink":"/journals/k8s/kube-object-no-match-for-kind-version/","section":"Journals","summary":"æœ€è¿‘åœ¨å‡ç´š helm release æ™‚é‡åˆ°äº†ä¸€å€‹éŒ¯èª¤ï¼Œæç¤º \u0026ldquo;no matches for kind HorizontalPodAutoscaler in version autoscaling/v2beta2\u0026rdquo;ã€‚","title":"Kube Object No Match for Kind Version","type":"journals"},{"content":"","date":"2 July 2025","externalUrl":null,"permalink":"/tags/mapkubeapis/","section":"Tags","summary":"","title":"mapkubeapis","type":"tags"},{"content":" ä»‹ç´¹ # PersistentVolume (PV) æ˜¯ Kubernetes ä¸­çš„ä¸€ç¨®è³‡æºï¼Œç”¨æ–¼æä¾›æŒä¹…åŒ–å­˜å„²ã€‚å®ƒæ˜¯é›†ç¾¤ç´šåˆ¥çš„å­˜å„²è³‡æºï¼Œèˆ‡ Pod çš„ç”Ÿå‘½é€±æœŸç„¡é—œã€‚PV å¯ä»¥è¢«å¤šå€‹ Pod å…±äº«ï¼Œä¸¦ä¸”å¯ä»¥åœ¨ Pod é‡å•Ÿæˆ–é‡æ–°èª¿åº¦æ™‚ä¿æŒæ•¸æ“šä¸è®Šã€‚\nç®¡ç†å“¡å¯ä»¥äº‹å…ˆå‰µå»º PVï¼Œä¸¦å°‡å…¶èˆ‡ç‰¹å®šçš„å­˜å„²ç³»çµ±ï¼ˆå¦‚ NFSã€iSCSIã€é›²å­˜å„²ç­‰ï¼‰ç¶å®šï¼Œæˆ–ä½¿ç”¨å‹•æ…‹å­˜å„²é¡åˆ¥ï¼ˆStorageClassï¼‰ä¾†è‡ªå‹•å‰µå»º PVã€‚\nPersistentVolumeClaim (PVC) æ˜¯ç”¨æˆ¶è«‹æ±‚å­˜å„²çš„æ–¹å¼ã€‚æ¦‚å¿µèˆ‡ Pod è«‹æ±‚è³‡æºé¡ä¼¼ã€‚ç”¨æˆ¶å¯ä»¥å‰µå»º PVCï¼ŒæŒ‡å®šæ‰€éœ€çš„å­˜å„²å¤§å°å’Œå­˜å–æ¨¡å¼ (å¦‚ ReadWriteOnceã€ReadOnlyMany ç­‰)ã€‚Kubernetes æœƒæ ¹æ“š PVC çš„è¦æ±‚ä¾†åŒ¹é…åˆé©çš„ PVã€‚\nå­˜å–æ¨¡å¼ # ReadWriteOnce (RWO)ï¼šå·åªèƒ½è¢«å–®å€‹ç¯€é»ä»¥è®€å¯«æ–¹å¼æ›è¼‰ã€‚ ReadOnlyMany (ROX)ï¼šå·å¯ä»¥è¢«å¤šå€‹ç¯€é»ä»¥åªè®€æ–¹å¼æ›è¼‰ã€‚ ReadWriteMany (RWX)ï¼šå·å¯ä»¥è¢«å¤šå€‹ç¯€é»ä»¥è®€å¯«æ–¹å¼æ›è¼‰ã€‚ PersistentVolume èˆ‡ PersistentVolumeClaim # graph pod(Pod) volume(Volume) PVC(PersistentVolumeClaim) PV(PersistentVolume) storageClass(StorageClass) storageProvider(StorageProvider) storage(Physical Storage) pod --\u003e|ä½¿ç”¨| volume --\u003e PVC PVC --\u003e|éœæ…‹ç¶å®š| PV PVC --\u003e|å‹•æ…‹ç¶å®š| storageClass PV --\u003e|æä¾›å­˜å„²| storage storageClass --\u003e|é…ç½®å­˜å„²| storageProvider --\u003e|å¯¦éš›å­˜å„²| storage å¦‚æœ PVC storageClassName å±¬æ€§ç‚º \u0026quot;\u0026quot;ï¼Œå‰‡è¡¨ç¤ºä½¿ç”¨éœæ…‹ç¶å®šã€‚é€™æ„å‘³è‘— PVC è‡ªèº«ç¦æ­¢ä½¿ç”¨å‹•æ…‹è£½å‚™çš„å·ã€‚\nåƒè€ƒ # [Kubernetes / K8s] PV/ PVC å„²å­˜å¤§å°äº‹äº¤çµ¦PV/PVCç®¡ç† æŒä¹…å· ","date":"2 July 2025","externalUrl":null,"permalink":"/posts/k8s/storage/","section":"Posts","summary":"ä»‹ç´¹ # PersistentVolume (PV) æ˜¯ Kubernetes ä¸­çš„ä¸€ç¨®è³‡æºï¼Œç”¨æ–¼æä¾›æŒä¹…åŒ–å­˜å„²ã€‚å®ƒæ˜¯é›†ç¾¤ç´šåˆ¥çš„å­˜å„²è³‡æºï¼Œèˆ‡ Pod çš„ç”Ÿå‘½é€±æœŸç„¡é—œã€‚PV å¯ä»¥è¢«å¤šå€‹ Pod å…±äº«ï¼Œä¸¦ä¸”å¯ä»¥åœ¨ Pod é‡å•Ÿæˆ–é‡æ–°èª¿åº¦æ™‚ä¿æŒæ•¸æ“šä¸è®Šã€‚","title":"PersistentVolume","type":"posts"},{"content":"","date":"2 July 2025","externalUrl":null,"permalink":"/tags/storage/","section":"Tags","summary":"","title":"storage","type":"tags"},{"content":" ä»‹ç´¹ # æ¯å€‹ StorageClass éƒ½åŒ…å« provisionerã€parametersã€reclaimPolicy é€™äº›å­—æ®µæœƒåœ¨ StorageClass éœ€è¦å‹•æ…‹é…ç½® PersistentVolume ä»¥æ»¿è¶³ PersistentVolumeClaim (PVC) ä½¿ç”¨åˆ°ã€‚\napiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: low-latency provisioner: csi-driver.example-vendor.example reclaimPolicy: Retain # é»˜è®¤å€¼æ˜¯ Delete allowVolumeExpansion: true mountOptions: - discard # è¿™å¯èƒ½ä¼šåœ¨å—å­˜å‚¨å±‚å¯ç”¨ UNMAP/TRIM volumeBindingMode: WaitForFirstConsumer parameters: guaranteedReadWriteLatency: \u0026#34;true\u0026#34; # è¿™æ˜¯æœåŠ¡æä¾›å•†ç‰¹å®šçš„ ç£ç¢Ÿå€æ’ä»¶ # æ¯å€‹ StorageClass éƒ½æœƒæœ‰ provisioner ï¼Œç”¨ä¾†æ±ºå®šä½¿ç”¨å“ªå€‹ç£ç¢Ÿå€æ’ä»¶ã€‚(å¿…è¦)\nå·æ’ä»¶ å…§ç½®è£½å‚™å™¨ é…ç½®ç¯„ä¾‹ AzureFile âœ“ Azure File CephFS - - FC - - FlexVolume - - iSCSI - - Local - Local NFS - NFS PortworxVolume âœ“ Portworx Volume RBD âœ“ Ceph RBD VsphereVolume âœ“ vSphere å›æ”¶ç­–ç•¥ # StorageClass å‹•æ…‹å»ºç«‹çš„ PersistentVolume æœƒåœ¨ reclaimPolicy æŒ‡å®šå›æ”¶ç­–ç•¥ï¼Œå¯ä»¥æ˜¯ Delete æˆ– Retain ã€‚é è¨­æ˜¯ Delete ã€‚\næ“´å±• # PersistentVolume å¯ä»¥é…ç½®ç‚ºå¯æ“´å……ï¼Œå…è¨±é€é PVC ç‰©ä»¶ä¾†èª¿æ•´ç£ç¢Ÿå€å¤§å°ï¼Œç”³è«‹ä¸€å€‹æ–°çš„ã€æ›´å¤§çš„å„²å­˜å®¹é‡ã€‚ç•¶ allowVolumeExpansion å®šç¾©ç‚º true æ™‚ï¼Œä¸‹åˆ—é¡å‹çš„ç£ç¢Ÿå€æ”¯æ´æ“´å……ã€‚\nå·é¡å‹ å·æ“´å±•çš„Kubernetes ç‰ˆæœ¬è¦æ±‚ Azure File 1.11 CSI 1.24 FlexVolume 1.13 Portworx 1.11 rbd 1.11 æ›è¼‰é¸é … # ç”± StorageClass å‹•æ…‹å»ºç«‹çš„ PersistentVolume å°‡ä½¿ç”¨é¡åˆ¥ä¸­ mountOptionsæŒ‡å®šçš„æ›è¼‰é¸é …ã€‚\nå¦‚æœç£ç¢Ÿå€æ’ä»¶ä¸æ”¯æ´æ›è¼‰é¸é …ï¼Œå»æŒ‡å®šäº†æ›è¼‰é¸é …ï¼Œå‰‡è£½å‚™æ“ä½œæœƒå¤±æ•—ã€‚ æ›è¼‰é¸é …åœ¨ StorageClass å’Œ PV ä¸Šéƒ½ä¸æœƒåšé©—è­‰ã€‚å¦‚æœå…¶ä¸­ä¸€å€‹æ›è¼‰é¸é …ç„¡æ•ˆï¼Œé‚£éº¼é€™å€‹PV æ›è¼‰ä½œæ¥­å°±æœƒå¤±æ•—ã€‚\nåƒè€ƒ # å‹•æ…‹å·è£½å‚™ ","date":"1 July 2025","externalUrl":null,"permalink":"/posts/k8s/storageclass/","section":"Posts","summary":"ä»‹ç´¹ # æ¯å€‹ StorageClass éƒ½åŒ…å« provisionerã€parametersã€reclaimPolicy é€™äº›å­—æ®µæœƒåœ¨ StorageClass éœ€è¦å‹•æ…‹é…ç½® PersistentVolume ä»¥æ»¿è¶³ PersistentVolumeClaim (PVC) ä½¿ç”¨åˆ°ã€‚","title":"StorageClass","type":"posts"},{"content":"","date":"24 September 2023","externalUrl":null,"permalink":"/tags/m1/","section":"Tags","summary":"","title":"m1","type":"tags"},{"content":"","date":"24 September 2023","externalUrl":null,"permalink":"/tags/m2/","section":"Tags","summary":"","title":"m2","type":"tags"},{"content":"","date":"24 September 2023","externalUrl":null,"permalink":"/tags/mac/","section":"Tags","summary":"","title":"mac","type":"tags"},{"content":"","date":"24 September 2023","externalUrl":null,"permalink":"/tags/minikube/","section":"Tags","summary":"","title":"minikube","type":"tags"},{"content":" ä»‹ç´¹ # minikube æ˜¯ä¸€å€‹è¼•é‡ç´šçš„ Kubernetes ç’°å¢ƒï¼Œä¸»è¦ç”¨æ–¼æœ¬åœ°é–‹ç™¼å’Œæ¸¬è©¦ã€‚å®ƒå¯ä»¥åœ¨æœ¬åœ°æ©Ÿå™¨ä¸Šå•Ÿå‹•ä¸€å€‹å–®ç¯€é»çš„ Kubernetes é›†ç¾¤ï¼Œè®“é–‹ç™¼è€…å¯ä»¥å¿«é€Ÿåœ°éƒ¨ç½²å’Œæ¸¬è©¦æ‡‰ç”¨ç¨‹å¼ã€‚\nminikube æ”¯æ´å¤šç¨®è™›æ“¬åŒ–æŠ€è¡“ï¼ŒåŒ…æ‹¬ VirtualBoxã€VMwareã€KVMã€Hyper-V ç­‰ç­‰ã€‚å®ƒå¯ä»¥åœ¨ Windowsã€macOS å’Œ Linux ä¸Šé‹è¡Œã€‚\nQemu # Qemu æ˜¯ä¸€å€‹é–‹æºçš„è™›æ“¬åŒ–è»Ÿé«”ï¼Œå¯ä»¥æ¨¡æ“¬å¤šç¨®ç¡¬é«”æ¶æ§‹ï¼ŒåŒ…æ‹¬ x86ã€ARMã€MIPS ç­‰ç­‰ã€‚å®ƒå¯ä»¥ç”¨æ–¼è™›æ“¬åŒ–å’Œæ¨¡æ“¬ä¸åŒçš„ä½œæ¥­ç³»çµ±å’Œæ‡‰ç”¨ç¨‹å¼ã€‚\nQemu çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š\nä½¿ç”¨è€…ç¨‹å¼æ¨¡æ“¬ï¼šQEMU èƒ½å¤ å°‡ç‚ºä¸€å€‹å¹³å°ç·¨è­¯çš„äºŒé€²ä½æª”æ¡ˆé‹è¡Œåœ¨å¦ä¸€å€‹ä¸åŒçš„å¹³å°ã€‚ ç³»çµ±è™›æ“¬åŒ–æ¨¡æ“¬ï¼šQEMU èƒ½å¤ æ¨¡æ“¬ä¸€å€‹å®Œæ•´çš„ç³»çµ±è™›æ“¬æ©Ÿï¼Œè©²è™›æ“¬æ©Ÿæœ‰è‡ªå·±çš„è™›æ“¬CPUã€æ™¶ç‰‡çµ„ã€è™›æ“¬è¨˜æ†¶é«”ä»¥åŠå„ç¨®è™›æ“¬å¤–éƒ¨è¨­å‚™ï¼Œèƒ½å¤ ç‚ºè™›æ“¬æ©Ÿä¸­é‹è¡Œçš„ä½œæ¥­ç³»çµ±å’Œæ‡‰ç”¨è»Ÿé«”å‘ˆç¾å‡ºèˆ‡å¯¦é«”é›»è…¦å®Œå…¨ä¸€è‡´çš„ç¡¬é«”è¦–åœ–ã€‚QEMUèƒ½å¤ æ¨¡æ“¬ x86ã€ARMã€MIPSã€PPC ç­‰å¤šå€‹å¹³å°ã€‚ Qemu åœ¨ macOS ä¸Šçš„ä½¿ç”¨ä¸»è¦æ˜¯ç‚ºäº†æ”¯æ´ M ç³»åˆ—æ™¶ç‰‡ï¼ˆå¦‚ M1ã€M2ï¼‰çš„è™›æ“¬åŒ–ï¼Œå› ç‚ºé€™äº›æ™¶ç‰‡ä½¿ç”¨ ARM æ¶æ§‹ï¼Œè€Œè¨±å¤šå‚³çµ±çš„è™›æ“¬åŒ–æŠ€è¡“ï¼ˆå¦‚ VirtualBoxï¼‰ä¸¦ä¸æ”¯æ´ ARM æ¶æ§‹ã€‚\nå®‰è£ # åœ¨ macOS ä¸Šå®‰è£ minikube å’Œ Qemuï¼Œå¯ä»¥ä½¿ç”¨ Homebrew ä¾†ç°¡åŒ–å®‰è£éç¨‹ã€‚ é¦–å…ˆï¼Œç¢ºä¿ä½ å·²ç¶“å®‰è£äº† Homebrewã€‚å¦‚æœé‚„æ²’æœ‰å®‰è£ï¼Œå¯ä»¥åƒè€ƒ Homebrew å®˜æ–¹ç¶²ç«™ é€²è¡Œå®‰è£ã€‚\nbrew install minikube brew install qemu æ¥è‘—ï¼Œç‚ºäº†è®“ minikube ä½¿ç”¨ Qemu ä½œç‚ºè™›æ“¬åŒ–é©…å‹•ç¨‹å¼ï¼Œæˆ‘å€‘éœ€è¦å®‰è£ socket_vmnetã€‚é€™æ˜¯ä¸€å€‹ç”¨æ–¼ macOS çš„ Qemu è™›æ“¬åŒ–ç¶²è·¯é©…å‹•ç¨‹å¼ã€‚\nbrew install socket_vmnet brew tap homebrew/services HOMEBREW=$(which brew) \u0026amp;\u0026amp; sudo ${HOMEBREW} services start socket_vmnet å•Ÿå‹• Minikube # åœ¨å®‰è£å®Œæˆå¾Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å•Ÿå‹• minikubeï¼Œä¸¦æŒ‡å®šä½¿ç”¨ Qemu ä½œç‚ºè™›æ“¬åŒ–é©…å‹•ç¨‹å¼ã€‚\nminikube start --driver qemu --network socket_vmnet åƒè€ƒè³‡æ–™ # How to Setup Minikube on MAC M1/M2 ","date":"24 September 2023","externalUrl":null,"permalink":"/posts/minikube/","section":"Posts","summary":"ä»‹ç´¹ # minikube æ˜¯ä¸€å€‹è¼•é‡ç´šçš„ Kubernetes ç’°å¢ƒï¼Œä¸»è¦ç”¨æ–¼æœ¬åœ°é–‹ç™¼å’Œæ¸¬è©¦ã€‚å®ƒå¯ä»¥åœ¨æœ¬åœ°æ©Ÿå™¨ä¸Šå•Ÿå‹•ä¸€å€‹å–®ç¯€é»çš„ Kubernetes é›†ç¾¤ï¼Œè®“é–‹ç™¼è€…å¯ä»¥å¿«é€Ÿåœ°éƒ¨ç½²å’Œæ¸¬è©¦æ‡‰ç”¨ç¨‹å¼ã€‚","title":"Minikube ç’°å¢ƒèˆ‡å®‰è£ (Mac M1/M2)","type":"posts"},{"content":"","date":"22 September 2023","externalUrl":null,"permalink":"/tags/cicd/","section":"Tags","summary":"","title":"cicd","type":"tags"},{"content":"","date":"22 September 2023","externalUrl":null,"permalink":"/tags/gitlab/","section":"Tags","summary":"","title":"gitlab","type":"tags"},{"content":" ä»‹ç´¹ # GitLab æ˜¯ä¸€å€‹é–‹æºçš„ DevOps å¹³å°ï¼Œæä¾›äº†ç‰ˆæœ¬æ§åˆ¶ã€CI/CDã€ä»£ç¢¼å¯©æŸ¥ç­‰åŠŸèƒ½ã€‚å®ƒçš„ CI/CD åŠŸèƒ½å¯ä»¥å¹«åŠ©é–‹ç™¼è€…è‡ªå‹•åŒ–è»Ÿé«”é–‹ç™¼æµç¨‹ï¼Œæé«˜é–‹ç™¼æ•ˆç‡å’Œè³ªé‡ã€‚\nGitLab çš„ CI/CD åŠŸèƒ½åŸºæ–¼ GitLab Runnerï¼Œå…è¨±é–‹ç™¼è€…å®šç¾©è‡ªå‹•åŒ–çš„å·¥ä½œæµç¨‹ï¼Œå¾ä»£ç¢¼æäº¤åˆ°éƒ¨ç½²ç”Ÿç”¢ç’°å¢ƒéƒ½å¯ä»¥è‡ªå‹•åŒ–å®Œæˆã€‚\nGitLab CI/CD çš„é…ç½®æ–‡ä»¶æ˜¯ .gitlab-ci.ymlï¼Œé€™å€‹æ–‡ä»¶å®šç¾©äº† CI/CD çš„å·¥ä½œæµç¨‹ï¼ŒåŒ…æ‹¬å„å€‹éšæ®µï¼ˆstagesï¼‰ã€ä»»å‹™ï¼ˆjobsï¼‰å’ŒåŸ·è¡Œçš„è…³æœ¬ï¼ˆscriptsï¼‰ã€‚é–‹ç™¼è€…å¯ä»¥æ ¹æ“šè‡ªå·±çš„éœ€æ±‚å®šç¾©ä¸åŒçš„å·¥ä½œæµç¨‹ï¼Œä¸¦ä¸”å¯ä»¥åœ¨ä¸åŒçš„éšæ®µä¸­åŸ·è¡Œä¸åŒçš„ä»»å‹™ã€‚\nåŸºæœ¬é…ç½® # ä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„ .gitlab-ci.yml é…ç½®ç¯„ä¾‹ï¼ŒåŒ…å«äº†ä¸‰å€‹éšæ®µï¼štestã€build å’Œ deployã€‚\nstages: - test - build - deploy test: stage: test script: # å®šç¾© test éšæ®µçš„æŒ‡ä»¤ - echo \u0026#34;Running tests\u0026#34; # åŸ·è¡Œå–®å…ƒæ¸¬è©¦ã€ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ç­‰ - npm test - npm run lint build: stage: build script: # å®šç¾© build éšæ®µçš„æŒ‡ä»¤ - echo \u0026#34;Building the application\u0026#34; - docker build -t $IMAGE_NAME:$TAG . # åªæœ‰ç•¶æ¸¬è©¦é€šéå¾Œæ‰åŸ·è¡Œ build needs: [\u0026#34;test\u0026#34;] deploy: stage: deploy script: # å®šç¾© deploy éšæ®µçš„æŒ‡ä»¤ - echo \u0026#34;Deploying to production\u0026#34; # åœ¨å¯¦éš›æƒ…æ³ä¸‹ï¼Œé€™è£¡å¯ä»¥æ˜¯éƒ¨ç½²åˆ° Kubernetesã€AWSã€GCP ç­‰çš„ç›¸æ‡‰æŒ‡ä»¤ # ä¹Ÿå¯ä»¥ä½¿ç”¨ Helm é€²è¡Œéƒ¨ç½² # åªæœ‰ç•¶ build æˆåŠŸå¾Œæ‰åŸ·è¡Œ deploy needs: [\u0026#34;build\u0026#34;] é€²éšé…ç½® # åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œé€šå¸¸éœ€è¦æ›´è¤‡é›œçš„é…ç½®ï¼Œä¾‹å¦‚ï¼šé…ç½®ç’°å¢ƒè®Šæ•¸ã€å»ºæ§‹ mysql è³‡æ–™åº«ã€redis ç­‰æœå‹™ã€‚\nstages: - test - build - deploy test: stage: test services: - name: mysql:5.7 alias: db - redis:latest alias: redis variables: MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD} MYSQL_DATABASE: ${MYSQL_DATABASE} REDIS_PASSWORD: ${REDIS_PASSWORD} script: - echo \u0026#34;Running tests\u0026#34; - npm test - npm run lint build: stage: build script: - echo \u0026#34;Building the application\u0026#34; - docker build -t $IMAGE_NAME:$TAG . needs: [\u0026#34;test\u0026#34;] deploy: stage: deploy script: - echo \u0026#34;Deploying to production\u0026#34; needs: [\u0026#34;build\u0026#34;] parallel:matrix # âš ï¸ å°æ–¼ runner çš„é…ç½®ï¼Œå¿…é ˆè¦æœ‰å¤šå° runner æˆ–è€…é…ç½®å–®å° runner é…ç½®æ”¯æ´åŒæ™‚åŸ·è¡Œå¤šå€‹ä»»å‹™ã€‚\nâš ï¸ çŸ©é™£çš„æ’åˆ—æ•¸ä¸èƒ½è¶…é 200\nparallel å¯ä»¥åœ¨å–®ä¸€çš„ pipeline ä¸­åŒæ™‚åŸ·è¡Œå¤šå€‹ä»»å‹™ï¼Œé€™å°æ–¼éœ€è¦åœ¨å¤šå€‹ç’°å¢ƒæˆ–é…ç½®ä¸‹é‹è¡Œç›¸åŒä»»å‹™çš„æƒ…æ³éå¸¸æœ‰ç”¨ã€‚\nå¦‚æœéœ€è¦åœ¨ä¸åŒçš„ Node.js ç‰ˆæœ¬å’Œç’°å¢ƒä¸‹é‹è¡Œæ¸¬è©¦ï¼Œå¯ä»¥ä½¿ç”¨ parallel:matrix ä¾†å®šç¾©ä¸€å€‹çŸ©é™£ï¼Œé€™æ¨£å¯ä»¥åœ¨ä¸åŒçš„é…ç½®ä¸‹åŒæ™‚é‹è¡Œç›¸åŒçš„ä»»å‹™ã€‚\ntest: stage: test script: - echo \u0026#34;Running tests\u0026#34; parallel: matrix: - NODE_VERSION: [10, 12, 14] - ENV: [development, production] åƒè€ƒ # Parallel ","date":"22 September 2023","externalUrl":null,"permalink":"/posts/gitlab/cicd/","section":"Posts","summary":"ä»‹ç´¹ # GitLab æ˜¯ä¸€å€‹é–‹æºçš„ DevOps å¹³å°ï¼Œæä¾›äº†ç‰ˆæœ¬æ§åˆ¶ã€CI/CDã€ä»£ç¢¼å¯©æŸ¥ç­‰åŠŸèƒ½ã€‚å®ƒçš„ CI/CD åŠŸèƒ½å¯ä»¥å¹«åŠ©é–‹ç™¼è€…è‡ªå‹•åŒ–è»Ÿé«”é–‹ç™¼æµç¨‹ï¼Œæé«˜é–‹ç™¼æ•ˆç‡å’Œè³ªé‡ã€‚","title":"GitLab CICD","type":"posts"},{"content":"","date":"17 September 2023","externalUrl":null,"permalink":"/tags/cni/","section":"Tags","summary":"","title":"cni","type":"tags"},{"content":"","date":"17 September 2023","externalUrl":null,"permalink":"/tags/node/","section":"Tags","summary":"","title":"node","type":"tags"},{"content":"","date":"17 September 2023","externalUrl":null,"permalink":"/tags/pod/","section":"Tags","summary":"","title":"pod","type":"tags"},{"content":" å‰è¨€ # æœ€è¿‘å…¬å¸å°ˆæ¡ˆè½‰é›²ç«¯æ¶æ§‹æ™‚ï¼Œç”±æ–¼æœå‹™åªèƒ½å•Ÿç”¨ä¸€å€‹ pod æä¾›ç·šä¸Šæœå‹™çš„é‹ä½œï¼Œå› æ­¤ä¹Ÿé¸æ“‡ä½¿ç”¨ statefulSet éƒ¨ç½²æœå‹™ï¼Œåœ¨é€™éç¨‹ä¸­ç™¼ç¾çš„å•é¡Œã€‚\näº‹ä»¶æµç¨‹ # RD åŒä»æ›´æ–°äº† code åˆ° gitLabï¼Œä½†æ²’æœ‰é †åˆ©å®Œæˆ CICDã€‚åŸå› æ˜¯ StatefulSet pod åœ¨é—œé–‰æ™‚åœç•™åœ¨ terminating ç‹€æ…‹ã€‚é›–ç„¶ k8s æœ‰ terminationGracePeriodSeconds è¨­å®šï¼Œä½†ç”±æ–¼æƒ…æ³ç‰¹æ®Šï¼Œç•¶ä¸‹çš„ terminationGracePeriodSeconds è¨­ç‚º 14400 ç§’ï¼Œé•·é”å››å°æ™‚ã€‚\nå› ç‚ºç·šä¸Šç·Šæ€¥å•é¡Œï¼Œæ‰€ä»¥é‡å° terminating pod æ¡å–äº†å¼·åˆ¶åˆªé™¤ï¼škubectl delete pod [pod name] --grace-period=0 --forceã€‚ä¹‹å¾Œé‡æ–°å»ºç«‹çš„ pod å°±æœƒå‡ºç¾ä»¥ä¸‹éŒ¯èª¤è¨Šæ¯ ğŸ‘‡\nWarning (combined from similar events): Failed to create pod sandbox: rpo error: code = Unknown desc = failed to setup network for sandbox \u0026#34;14fe0cd3d688aed4ffed4c36ffab1a145230449881bcbe4cac6478a63412b0c*: plugin type=*gke\u0026#34; failed (add): container veth name provided (etho) already exists Google Support # å…¶å¯¦å‰é™£å­é€™å€‹éŒ¯èª¤å·²ç¶“å½±éŸ¿åˆ°é–‹ç™¼å’Œæ¸¬è©¦ç’°å¢ƒäº†ã€‚ç”±æ–¼é€™æ¬¡å½±éŸ¿åˆ°æ­£å¼ç’°å¢ƒï¼Œæˆ‘å€‘æŠŠæ¡ˆä»¶ç­‰ç´šæå‡è‡³ P1ï¼Œä¸¦è«‹ Google å”åŠ©æŸ¥æ‰¾éŒ¯èª¤ç™¼ç”Ÿçš„åŸå› ã€‚\nç¶“é Google å”åŠ©åˆ†æï¼Œé€™æ¬¡éŒ¯èª¤çš„ä¸»è¦åŸå› å¦‚ä¸‹ï¼š\nç•¶ pod é€²å…¥é—œé–‰æµç¨‹æ™‚ï¼Œç”±æ–¼ terminationGracePeriodSeconds è¨­ç½®ç‚ºå››å°æ™‚ï¼Œpod ä»è™•æ–¼ lifecycle ä¸­ æ­¤æ™‚ä½¿ç”¨ kubectl delete pod --force æœƒå°è‡´ pod é›–ç„¶æ¶ˆå¤±ï¼Œä½† container è¨­å®šä»æ®˜ç•™åœ¨ node ä¸Š å¦‚æœæ–°çš„ pod é‡æ–°åœ¨åŒä¸€é¡† node ä¸Šå•Ÿå‹•ï¼Œå°±æœƒé€ æˆç›¸åŒçš„ç¶²è·¯ä»‹é¢è¨­å®šè¡çª é›–ç„¶æ”¹æˆ Deployment å¯ä»¥è¦é¿æ­¤å•é¡Œï¼Œä½†ç›¸å°æœƒæµªè²»ä¸€çµ„ IPã€‚é•·ä¹…ä¸‹ä¾†ä¸€æ¨£æœƒæœ‰å•é¡Œï¼Œæœ€é‡è¦çš„é‚„æ˜¯è¦è®“ pod å®Œæ•´çµæŸæ•´å€‹ lifecycleï¼Œæ‰ä¸æœƒç”¢ç”Ÿå¾ŒçºŒå•é¡Œã€‚\næŠ€è¡“ç´°ç¯€è£œå…… # Container Network Interface (CNI) åœ¨ Kubernetes ä¸­è² è²¬ç®¡ç† Pod çš„ç¶²è·¯è¨­å®šã€‚ç•¶ Pod å•Ÿå‹•æ™‚ï¼ŒCNI æœƒç‚ºå…¶å‰µå»ºä¸€å€‹è™›æ“¬ç¶²è·¯ä»‹é¢ (veth pair)ï¼Œä¸¦å°‡å…¶é€£æ¥åˆ° Pod çš„ç¶²è·¯å‘½åç©ºé–“ã€‚\nåƒè€ƒè³‡æ–™ # Pods stuck on ContainerCreating after containerd is restarted ","date":"17 September 2023","externalUrl":null,"permalink":"/journals/k8s/veth-name-provided-already-exists/","section":"Journals","summary":"å‰è¨€ # æœ€è¿‘å…¬å¸å°ˆæ¡ˆè½‰é›²ç«¯æ¶æ§‹æ™‚ï¼Œç”±æ–¼æœå‹™åªèƒ½å•Ÿç”¨ä¸€å€‹ pod æä¾›ç·šä¸Šæœå‹™çš„é‹ä½œï¼Œå› æ­¤ä¹Ÿé¸æ“‡ä½¿ç”¨ statefulSet éƒ¨ç½²æœå‹™ï¼Œåœ¨é€™éç¨‹ä¸­ç™¼ç¾çš„å•é¡Œã€‚","title":"è§£æ±º Kubernetes Pod ç¶²è·¯è¡çªï¼šcontainer veth name provided (eth0) already exists","type":"journals"},{"content":"","date":"27 August 2023","externalUrl":null,"permalink":"/tags/docker/","section":"Tags","summary":"","title":"docker","type":"tags"},{"content":" Dockerfile # Dockerfile æ˜¯ Docker çš„æ ¸å¿ƒçµ„ä»¶ä¹‹ä¸€ï¼Œç”¨ä¾†å®šç¾©å¦‚ä½•å»ºæ§‹ä¸€å€‹ Docker æ˜ åƒæª”ï¼ˆimageï¼‰ã€‚å®ƒæ˜¯ä¸€å€‹æ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—çš„æŒ‡ä»¤å’Œåƒæ•¸ï¼Œé€™äº›æŒ‡ä»¤å‘Šè¨´ Docker å¦‚ä½•å¾åŸºç¤æ˜ åƒé–‹å§‹ï¼Œå®‰è£å¿…è¦çš„è»Ÿé«”ã€é…ç½®ç’°å¢ƒè®Šæ•¸ã€è¤‡è£½æª”æ¡ˆç­‰ã€‚\nå¯ä»¥ä¿è­‰æ¯æ¬¡ä½¿ç”¨ç›¸åŒçš„ Dockerfile å»ºæ§‹å‡ºä¾†çš„æ˜ åƒæª”éƒ½æ˜¯ä¸€è‡´çš„ï¼Œé€™å°æ–¼éƒ¨ç½²å’Œç¶­è­·æ‡‰ç”¨ç¨‹å¼éå¸¸é‡è¦ã€‚\né€™è£¡è¦æ³¨æ„ EXPOSEï¼Œå®ƒç”¨ä¾†å‘Šè¨´ Docker å“ªäº›ç«¯å£éœ€è¦æš´éœ²çµ¦å¤–éƒ¨è¨ªå•ã€‚ä½†æ˜¯é‚„æ˜¯å¿…é ˆè¦åœ¨ docker run æ™‚ä½¿ç”¨ -p é¸é …ä¾†å¯¦éš›æ˜ å°„ç«¯å£ã€‚\n# åŸºç¤æ˜ åƒï¼Œé€™è£¡ä½¿ç”¨ Alpine Linuxï¼Œå¦‚æœæ²’æœ‰æŒ‡å®š tagï¼Œå‰‡é»˜èªä½¿ç”¨ latest FROM alpine # è¨­å®šä½œè€…è³‡è¨Š LABEL maintainer=\u0026#34;bing-wei\u0026#34; # è¨­å®šå·¥ä½œç›®éŒ„ WORKDIR /app # è¤‡è£½ç•¶å‰ç›®éŒ„ä¸‹çš„æ‰€æœ‰æª”æ¡ˆåˆ°å®¹å™¨çš„ /app ç›®éŒ„ COPY . . # å®‰è£å¿…è¦çš„å¥—ä»¶ RUN apk add --no-cache python3 py3-pip # å®‰è£ Python ç›¸ä¾å¥—ä»¶ RUN pip3 install -r requirements.txt # è¨­å®šç’°å¢ƒè®Šæ•¸ ENV PYTHONUNBUFFERED=1 # æš´éœ²å®¹å™¨çš„ 8000 ç«¯å£ EXPOSE 8000 # è¨­å®šå®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œçš„å‘½ä»¤ CMD [\u0026#34;python3\u0026#34;, \u0026#34;app.py\u0026#34;] å¤šéšæ®µå»ºæ§‹ # åœ¨å¯¦éš›çš„ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œé€šå¸¸æœƒä½¿ç”¨å¤šéšæ®µå»ºæ§‹ï¼ˆmulti-stage buildsï¼‰ä¾†æ¸›å°‘æœ€çµ‚æ˜ åƒæª”çš„å¤§å°ï¼Œé€™æ¨£å¯ä»¥åœ¨é–‹ç™¼éšæ®µå®‰è£æ‰€æœ‰å¿…è¦çš„å·¥å…·å’Œä¾è³´ï¼Œä½†åœ¨æœ€çµ‚æ˜ åƒæª”ä¸­åªä¿ç•™é‹è¡Œæ‡‰ç”¨ç¨‹å¼æ‰€éœ€çš„éƒ¨åˆ†ã€‚\n# ç¬¬ä¸€éšæ®µï¼šå»ºæ§‹éšæ®µ FROM node:14 AS build WORKDIR /app COPY package*.json ./ RUN npm install COPY . . RUN npm run build # ç¬¬äºŒéšæ®µï¼šé‹è¡Œéšæ®µ FROM nginx:alpine COPY --from=build /app/dist /usr/share/nginx/html EXPOSE 80 CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] å®‰å…¨æ€§è€ƒé‡ # åœ¨æ’°å¯« Dockerfile æ™‚ï¼Œé‚„éœ€è¦è€ƒæ…®å®‰å…¨æ€§å•é¡Œï¼Œä¾‹å¦‚ï¼š\nä½¿ç”¨å®˜æ–¹çš„åŸºç¤æ˜ åƒï¼Œé€™æ¨£å¯ä»¥æ¸›å°‘å®‰å…¨æ¼æ´çš„é¢¨éšªã€‚ é¿å…ä½¿ç”¨ latest æ¨™ç±¤ï¼Œå› ç‚ºé€™æ¨£æœƒå°è‡´æ˜ åƒæª”åœ¨ä¸åŒæ™‚é–“é»å¯èƒ½æœ‰ä¸åŒçš„å…§å®¹ï¼Œæ‡‰è©²ä½¿ç”¨å…·é«”çš„ç‰ˆæœ¬è™Ÿã€‚ å»ºç«‹å¸³è™Ÿå’Œè¨­å®šæ¬Šé™ï¼Œé¿å…ä½¿ç”¨ root å¸³è™Ÿé‹è¡Œæ‡‰ç”¨ç¨‹å¼ã€‚ # ä½¿ç”¨å®˜æ–¹çš„ Node.js æ˜ åƒ FROM node:14 # å»ºç«‹ä¸€å€‹é root ä½¿ç”¨è€… RUN useradd -m appuser # åˆ‡æ›åˆ°é root ä½¿ç”¨è€… USER appuser # è¨­å®šå·¥ä½œç›®éŒ„ WORKDIR /home/appuser/app # è¤‡è£½ package.json å’Œ package-lock.json COPY package*.json ./ # å®‰è£ç›¸ä¾å¥—ä»¶ RUN npm install --only=production # è¤‡è£½æ‡‰ç”¨ç¨‹å¼æª”æ¡ˆ COPY --chown=appuser:appuser . . # æš´éœ²æ‡‰ç”¨ç¨‹å¼ç«¯å£ EXPOSE 3000 # è¨­å®šå®¹å™¨å•Ÿå‹•å‘½ä»¤ CMD [\u0026#34;npm\u0026#34;, \u0026#34;start\u0026#34;] ","date":"27 August 2023","externalUrl":null,"permalink":"/posts/dockerfile/","section":"Posts","summary":"Dockerfile # Dockerfile æ˜¯ Docker çš„æ ¸å¿ƒçµ„ä»¶ä¹‹ä¸€ï¼Œç”¨ä¾†å®šç¾©å¦‚ä½•å»ºæ§‹ä¸€å€‹ Docker æ˜ åƒæª”ï¼ˆimageï¼‰ã€‚å®ƒæ˜¯ä¸€å€‹æ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—çš„æŒ‡ä»¤å’Œåƒæ•¸ï¼Œé€™äº›æŒ‡ä»¤å‘Šè¨´ Docker å¦‚ä½•å¾åŸºç¤æ˜ åƒé–‹å§‹ï¼Œå®‰è£å¿…è¦çš„è»Ÿé«”ã€é…ç½®ç’°å¢ƒè®Šæ•¸ã€è¤‡è£½æª”æ¡ˆç­‰ã€‚","title":"Dockerfile","type":"posts"},{"content":"","date":"19 August 2023","externalUrl":null,"permalink":"/tags/ingress/","section":"Tags","summary":"","title":"ingress","type":"tags"},{"content":"éš¨è‘—ç³»çµ±æ¶æ§‹æ—¥ç›Šè¤‡é›œï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å¤šå€‹ Ingress ä¾†åˆ†é›¢ä¸åŒæœå‹™çš„æµé‡ç®¡ç†ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯ç•¶æŸå€‹ Ingress ç™¼ç”Ÿç•°å¸¸æ™‚ï¼Œä¸æœƒå½±éŸ¿åˆ°æ‰€æœ‰æœå‹™çš„é‹ä½œã€‚\nä¸éç¼ºé»æ˜¯æ¯å€‹ Ingress éƒ½éœ€è¦ä½¿ç”¨éœæ…‹ IPï¼Œåœ¨ GCP ç­‰é›²ç«¯æœå‹™ä¸­ï¼Œæ¯å€‹ä¿ç•™çš„éœæ…‹ IP éƒ½æœƒå¢åŠ æˆæœ¬ã€‚\næˆ‘å€‘å¯ä»¥ä½¿ç”¨ Ingress Controller ä¾†çµ±ä¸€ç®¡ç†æ‰€æœ‰çš„ Ingress è³‡æºï¼Œåªä½¿ç”¨ä¸€å€‹æˆ–å°‘æ•¸å¹¾å€‹éœæ…‹ IPï¼Œé€™æ¨£å¯ä»¥é™ä½æˆæœ¬ä¸¦ç°¡åŒ–ç®¡ç†ã€‚\nä¸Šä¸€ç¯‡æ–‡ç« ä¸­æœ‰æåˆ° ingressï¼Œå¦‚æœæƒ³ç­è§£ ingress å¯ä»¥å…ˆåƒè€ƒæˆ–é ç¿’é€™ç¯‡æ–‡ç« ã€‚\nIngress 6 August 2023\u0026middot;1 åˆ†é˜ kubernetes ingress Ingress Nginx Controller # Ingress Nginx Controller çµåˆäº† Ingress çš„ç°¡æ½”ä¸¦æ”¯æ´ Nginx ç›¸é—œçš„æ“´å……åŠŸèƒ½ï¼Œè®“æˆ‘å€‘èƒ½æ›´å¥½çš„ç®¡ç†æ‰€æœ‰çš„ ingressã€‚\nNginx # é«˜æ•ˆèƒ½çš„ webServer é å‹å‚³çµ± apache server çš„è³‡æºèˆ‡æ•ˆèƒ½ å¤§é‡çš„æ¨¡çµ„èˆ‡æ“´å……åŠŸèƒ½ å……è¶³çš„å®‰å…¨æ€§åŠŸèƒ½ è¼•é‡ å®¹æ˜“æ°´å¹³æ“´å±• Ingress # Service é€£æ¥ LoadBalance è¨­å®š SSL/TLS çµ‚ç«¯ è™›æ“¬ä¸»æ©Ÿè¨­å®š å®‰è£ # helm upgrade --install ingress-nginx ingress-nginx \\ --repo https://kubernetes.github.io/ingress-nginx \\ --namespace ingress-nginx --create-namespace å¯¦éš›ç¯„ä¾‹ # åŸºæœ¬ Ingress è¨­å®š # apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: example-ingress annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; nginx.ingress.kubernetes.io/rewrite-target: / spec: rules: - host: example.com http: paths: - path: / pathType: Prefix backend: service: name: example-service port: number: 80 é€²éšè¨­å®šç¯„ä¾‹ # apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: advanced-ingress annotations: kubernetes.io/ingress.class: \u0026#34;nginx\u0026#34; nginx.ingress.kubernetes.io/ssl-redirect: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/rate-limit: \u0026#34;10\u0026#34; cert-manager.io/cluster-issuer: \u0026#34;letsencrypt-prod\u0026#34; spec: tls: - hosts: - secure.example.com secretName: example-tls rules: - host: secure.example.com http: paths: - path: /api pathType: Prefix backend: service: name: api-service port: number: 8080 graph LR ingress1(Ingress-1) ingress2(Ingress-2) ingress3(Ingress-3) subgraph Ingress Nginx Controller controller(Controller) admission(Admission Webhook) nginx(Nginx) controller --\u003e|é…ç½®| nginx controller --\u003e|é©—è­‰| admission end ingress1 --\u003e|ç®¡ç†| controller ingress2 --\u003e|ç®¡ç†| controller ingress3 --\u003e|ç®¡ç†| controller åƒè€ƒè³‡æ–™ # ä½¿ç”¨ Helm ä¾†å®‰è£ Ingress Controller ingress-nginx ","date":"19 August 2023","externalUrl":null,"permalink":"/posts/k8s/ingress-nginx/","section":"Posts","summary":"éš¨è‘—ç³»çµ±æ¶æ§‹æ—¥ç›Šè¤‡é›œï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å¤šå€‹ Ingress ä¾†åˆ†é›¢ä¸åŒæœå‹™çš„æµé‡ç®¡ç†ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯ç•¶æŸå€‹ Ingress ç™¼ç”Ÿç•°å¸¸æ™‚ï¼Œä¸æœƒå½±éŸ¿åˆ°æ‰€æœ‰æœå‹™çš„é‹ä½œã€‚","title":"Ingress Nginx Controller","type":"posts"},{"content":" ä»‹ç´¹ # ingress æ˜¯ k8s çµ¦ service æä¾›å¤–éƒ¨è¨ªå•çš„ URLã€SSLã€è·¯ç”±ç­‰åŠŸèƒ½ã€‚ å¯ä»¥ç†è§£ç‚º nginx æˆ– traefik ç­‰çš„ä»£ç†å·¥å…·ã€‚å…è¨±é€éæŸå€‹ URL é€²å…¥å°æ‡‰çš„ serviceï¼Œä¸”ç¢°åˆ°æŸäº› route èƒ½å¤  proxy pass åˆ°å…¶ä»– serviceã€‚\nâ­ ingress åˆåˆ†æˆå¤–éƒ¨è² è¼‰å¹³è¡¡ã€å…§éƒ¨è² è¼‰å¹³è¡¡ã€‚å…©è€…åœ¨ä½¿ç”¨è¨­å®šä¸Šæœ‰ä¸€äº›å°å°çš„ä¸åŒã€‚\nå¤–éƒ¨è² è¼‰å¹³è¡¡ # é€šå¸¸å°å¤–éƒ¨çš„è² è¼‰å¹³è¡¡å…¥å£ï¼Œéƒ½æœƒè¨­ç½®é˜²ç«ç‰†æˆ–æ˜¯ç™½åå–®ç®¡ç†ä½†æ˜¯ k8s ingress å»ä¸èƒ½ç›´æ¥å¯¦ç¾ã€‚éœ€è¦é€éä¸€äº› gcp å…ƒä»¶åŠŸèƒ½ï¼Œä¾†è¨­ç½®é˜²ç«ç‰†æˆ–ç™½åå–®ç®¡ç†ã€‚\ncloud armor # armor çš„ç¿»è­¯æ˜¯æŒ‡ç›”ç”²çš„æ„æ€ï¼Œé€™æ˜¯ç”± gcp æä¾›çš„æœå‹™ï¼Œå…·æœ‰åˆ†æ•£å¼é˜»æ–·æ”»æ“Š(DDos)é˜²è­·æ©Ÿåˆ¶ã€ç¶²è·¯æ‡‰ç”¨ç¨‹å¼é˜²ç«ç‰†ã€‚å¯ä»¥æ­é… loadBalanceã€Cloud CDN ä¾†å¼·åŒ–ç¶²è·¯å®‰å…¨æœå‹™ã€‚\né‚£éº¼æˆ‘å€‘è¦å¦‚ä½•å°‡ cloud armor æ‡‰ç”¨åœ¨æˆ‘å€‘ ingress ä¸Šé¢å‘¢ï¼Ÿæ¥è‘—çœ‹ä¸‹å» ğŸ˜\né¦–å…ˆæˆ‘å€‘å¯ä»¥å…ˆæ‰¾å®˜æ–¹çš„ä½¿ç”¨æ‰‹å†Š Configuring Ingress using the default controller æ¥è‘—å°‡é‡é»æ”¾åœ¨ backendConfig è¨­å®šä¸Šé¢ï¼Œå‰é¢çš„ä»‹ç´¹å·²ç¶“çŸ¥é“ ingress è² è²¬ä¾æ“šè·¯ç”±è¦å‰‡ä»£ç†è½‰ç™¼ã€‚æ–‡ä»¶ä¸Š backenConfig èˆ‡ service å¯ä»¥è€¦åˆã€‚ä½¿ç”¨ backendConfig çš„è¨­å®šã€‚\nBackendConfig and FrontendConfig overview è©³ç´°æƒ³çŸ¥é“ backendConfig è¨­å®šç¯„ä¾‹å¯ä»¥åœ¨æ–‡ä»¶é€£æ¥å…§æ‰¾åˆ° ğŸ‘‰ Configuring Ingress features through BackendConfig parameters æ¥è‘—ä¸‹é¢ç¹ªè£½ä¸€å¼µå¤–éƒ¨è² è¼‰å¹³è¡¡çš„æ¶æ§‹åœ–ã€‚å¯ä»¥çœ‹åˆ°ä¸‹åœ–ä¸­ 114.1.46.157 çš„å®¢æˆ¶ç«¯åœ¨è¨ªå•çš„æ™‚å€™è¢« ingress çµ¦æ“‹ä¸‹äº†ã€‚\nåŸå› æ˜¯ ingress å¾Œç«¯ service æœ‰è€¦åˆ backendConfigï¼Œé€é backendConfig ä½¿ç”¨äº† cloud armorã€‚\nflowchart LR cli1(client 34.xxx.xxx.xxx) cli2(client 114.1.46.157) cli1 --\u003e ing cli2 --x ing subgraph k8s-cluster ing((ingress)) svc-web(web-service) svc-api(api-service) df-backend(backend-config) armor{{cloud-armor}} ing --\u003e svc-web ing --\u003e svc-api armor -.- df-backend df-backend -.-\u003e svc-web df-backend -.-\u003e svc-api end å…§éƒ¨è² è¼‰å¹³è¡¡ # è¬›å®Œäº†å¤–éƒ¨è² è¼‰å¹³è¡¡ï¼Œæ¥è‘—è¬› ingress æ“”ä»»å…§éƒ¨è² è¼‰å¹³è¡¡æ™‚ï¼Œéœ€è¦æ³¨æ„çš„äº‹é …ã€‚\nNetwork endpoint group # ä»€éº¼æ˜¯ NEG ?\nNEG æ˜¯æŒ‡ Network endpoint groupï¼Œæ˜¯ä¸€ç¨®é…ç½®ã€‚æ„æ€æ˜¯æŒ‡å®šä¸€çµ„å¾Œç«¯ endpoint æˆ– serviceï¼Œå€ŸåŠ©NEGï¼ŒGoogle Cloud è² è¼‰å‡è¡¡å™¨å¯ä»¥ç‚ºåŸºæ–¼ GCE çš„å·¥ä½œè² è¼‰ã€ç„¡æœå‹™å™¨å·¥ä½œè² è¼‰å’Œå®¹å™¨åŒ–å·¥ä½œè² è¼‰æä¾›æœå‹™ã€‚å¯ä»¥æ›´ç²¾ç´°çš„å°‡æµé‡åˆ†é…åˆ°è² è¼‰å‡è¡¡å™¨çš„å¾Œç«¯ã€‚\nä½¿ç”¨æ™‚ï¼Œå°å¾Œç«¯çš„ service å¿…é ˆè¦ä½¿ç”¨ NEGï¼Œè©³ç´°æƒ³è¦äº†è§£å¯ä»¥åƒè€ƒ ğŸ‘‰ Network endpoint groups overview ","date":"6 August 2023","externalUrl":null,"permalink":"/posts/k8s/ingress/","section":"Posts","summary":"ä»‹ç´¹ # ingress æ˜¯ k8s çµ¦ service æä¾›å¤–éƒ¨è¨ªå•çš„ URLã€SSLã€è·¯ç”±ç­‰åŠŸèƒ½ã€‚ å¯ä»¥ç†è§£ç‚º nginx æˆ– traefik ç­‰çš„ä»£ç†å·¥å…·ã€‚å…è¨±é€éæŸå€‹ URL é€²å…¥å°æ‡‰çš„ serviceï¼Œä¸”ç¢°åˆ°æŸäº› route èƒ½å¤  proxy pass åˆ°å…¶ä»– serviceã€‚","title":"Ingress","type":"posts"},{"content":" åŒ¯å‡º/åŒ¯å…¥ # export å’Œ save éƒ½æ˜¯ç”¨ä¾†åŒ¯å‡º docker çš„æ˜ åƒæª”ï¼Œä½†æ˜¯æœ‰äº›ä¸åŒä¹‹è™•ï¼š\nexport å¯ä»¥åŒ¯å‡ºåœ¨å®¹å™¨ä¸­å·²è®Šæ›´çš„è¨­å®šï¼Œä¾‹å¦‚å®‰è£çš„è»Ÿé«”æˆ–ä¿®æ”¹çš„é…ç½®æª”æ¡ˆã€‚ save å–®ç´”åŒ¯å‡ºæ˜ åƒæª”ï¼Œä¸åŒ…å«åœ¨å®¹å™¨ä¸­å·²è®Šæ›´çš„è¨­å®šã€‚ åœ¨ä½¿ç”¨ä¸Šè¦æ³¨æ„ï¼Œå¦‚æœæ˜ åƒæª”ä½¿ç”¨ export åŒ¯å‡ºï¼Œå‰‡éœ€è¦ä½¿ç”¨ import åŒ¯å…¥ï¼›å¦‚æœä½¿ç”¨ save åŒ¯å‡ºï¼Œå‰‡éœ€è¦ä½¿ç”¨ load åŒ¯å…¥ã€‚\ndocker export image \u0026gt; filename.tar docker import \u0026lt; filename.tar docker save image \u0026gt; filename.tar docker load \u0026lt; filename.tar èˆ‡å®¹å™¨é€²è¡Œäº¤äº’ # é€šå¸¸æˆ‘å€‘æœƒä½¿ç”¨ docker run æŒ‡ä»¤ä¾†å•Ÿå‹•å®¹å™¨ï¼Œå¦‚æœéœ€è¦èˆ‡å®¹å™¨é€²è¡Œäº¤äº’ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹é¸é …ï¼š\ndocker run -it image /bin/bash å¦‚æœè¦é€€å‡ºå®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨ exit æˆ– ctrl+dã€‚\næŸ¥çœ‹å®¹å™¨ # å¦‚æœè¦æŸ¥çœ‹æ­£åœ¨é‹è¡Œçš„å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ docker psï¼Œå¦‚æœè¦æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„å®¹å™¨ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ docker ps -aã€‚\ndocker ps -a æŸ¥çœ‹å®¹å™¨å…§çš„æ¨™æº–è¼¸å‡º # å¦‚æœè¦æŸ¥çœ‹å®¹å™¨å…§çš„æ¨™æº–è¼¸å‡ºï¼Œå¯ä»¥ä½¿ç”¨ docker logs ï¼Œä½†æ˜¯é€šå¸¸æˆ‘å€‘æœƒæŒçºŒçš„è§€å¯Ÿå®¹å™¨çš„æ¨™æº–è¼¸å‡ºï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ -f é¸é …ä¾†æŒçºŒæŸ¥çœ‹ã€‚\ndocker logs -f container æŸ¥çœ‹å®¹å™¨å•Ÿå‹•é€²ç¨‹ # docker top container å®¹å™¨è³‡æºä½¿ç”¨ç‹€æ³ # docker stats æ¸…ç†æŠ€å·§ # â­ pruneæ“ä½œæ˜¯æ‰¹é‡åˆªé™¤é¡çš„å±éšªæ“ä½œï¼Œä½¿ç”¨ y ç¢ºèªã€‚ä¸æƒ³è¦è¼¸å…¥å¯ä»¥æ·»åŠ  -fï¼Œæ…ç”¨!\næ¸…é™¤æ‰€æœ‰åœæ­¢é‹è¡Œçš„å®¹å™¨ # docker container prune æ¸…ç†æœªä½¿ç”¨çš„æ˜ åƒæª” # docker image prune æ¸…ç†æ‰€æœ‰ç„¡ç”¨çš„å· # docker volume prune åƒè€ƒ # æ¸…ç† Docker çš„ containerï¼Œimage èˆ‡ volume ","date":"30 July 2023","externalUrl":null,"permalink":"/posts/docker/","section":"Posts","summary":"åŒ¯å‡º/åŒ¯å…¥ # export å’Œ save éƒ½æ˜¯ç”¨ä¾†åŒ¯å‡º docker çš„æ˜ åƒæª”ï¼Œä½†æ˜¯æœ‰äº›ä¸åŒä¹‹è™•ï¼š","title":"Docker","type":"posts"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"},{"content":"","externalUrl":null,"permalink":"/tags/session/","section":"Tags","summary":"","title":"session","type":"tags"},{"content":"","externalUrl":null,"permalink":"/tags/sticky-session/","section":"Tags","summary":"","title":"sticky session","type":"tags"},{"content":" å‰è¨€ # è¿‘æœŸå…¬å¸æœ‰ socket.io çš„æœå‹™éœ€è¦å¯ä»¥æ“´å±•ï¼Œç”±æ–¼æ˜¯èŠå¤©å®¤æœå‹™ï¼Œæœ‰å¯¦æ™‚çš„é›™å‘é€šä¿¡éœ€æ±‚ï¼ˆå¦‚èŠå¤©å®¤ã€éŠæˆ²ã€å¯¦æ™‚å”ä½œå·¥å…·ï¼‰ã€‚ä¿æŒç”¨æˆ¶ç«¯ä¿æŒèˆ‡åŒä¸€æœå‹™å™¨çš„é€£æ¥å¯ä»¥ï¼š\nç¢ºä¿æ¶ˆæ¯é †åºä¸€è‡´æ€§ æ¸›å°‘é€£æ¥é‡å»ºçš„é–‹éŠ· ç¶­è­·å¯¦æ™‚ç‹€æ…‹åŒæ­¥ å¯¦ä½œ # å»ºç«‹ backendConfig è¨­å®š sessionAffinityã€‚ apiVersion: cloud.google.com/v1 kind: BackendConfig metadata: name: socket-backendconfig spec: sessionAffinity: affinityType: \u0026#34;GENERATED_COOKIE\u0026#34; # Options: NONE, CLIENT_IP, GENERATED_COOKIE affinityCookieTtlSec: 50 åœ¨ kubernetes çš„ serivce ä¸­ï¼Œè¦å…ˆè¨­å®š network endpoint group (NEG)ï¼Œè¨­å®šçš„æ–¹å¼æœ‰å…©ç¨®ï¼š\nç¨ç«‹å‰µå»º NEGï¼Œä¸ç®¡æœ‰æ²’æœ‰å¥—ç”¨ google load balancer éƒ½æœƒå‰µå»ºä¸€å€‹ NEGã€‚ apiVersion: v1 kind: Service metadata: name: socket-service annotations: cloud.google.com/neg: \u0026#39;{\u0026#34;exposed_ports\u0026#34;: {\u0026#34;80\u0026#34;:{\u0026#34;name\u0026#34;: \u0026#34;NEG_NAME\u0026#34;}}}\u0026#39; cloud.google.com/backend-config: \u0026#39;{\u0026#34;default\u0026#34;: \u0026#34;socket-backendconfig\u0026#34;}\u0026#39; spec: selector: app: socket-app ports: - protocol: TCP port: 80 targetPort: 3000 type: ClusterIP sessionAffinity: ClientIP ä¾è³´æ–¼ google load balancer çš„è‡ªå‹•å‰µå»º NEGã€‚ apiVersion: v1 kind: Service metadata: name: socket-service annotations: cloud.google.com/neg: \u0026#39;{\u0026#34;exposed_ports\u0026#34;: {\u0026#34;80\u0026#34;:{\u0026#34;name\u0026#34;: \u0026#34;NEG_NAME\u0026#34;}}}\u0026#39; cloud.google.com/backend-config: \u0026#39;{\u0026#34;default\u0026#34;: \u0026#34;socket-backendconfig\u0026#34;}\u0026#39; spec: selector: app: socket-app ports: - protocol: TCP port: 80 targetPort: 3000 type: ClusterIP sessionAffinity: ClientIP å»ºç«‹ ingress\né€™é‚Šè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ï¼Œé€™æ¬¡å¯¦ä½œä½¿ç”¨çš„æ˜¯ GCP çš„ NEGï¼Œä¹Ÿæ˜¯è¦æ­é… GCP çš„ load balancer ä½¿ç”¨ã€‚æ‰èƒ½é”åˆ°é€™æ¬¡å¯¦ä½œçš„éœ€æ±‚ã€‚\nå› ç‚ºæœ‰ä½¿ç”¨è‡ªå·±åœ¨ github é–‹æºå°ˆæ¡ˆå»ºç«‹çš„ ingress-nginx ï¼Œé€²è¡Œä¸²æ¥ã€‚ä½†æ˜¯åœ¨å‰ç«¯æª¢æŸ¥çš„æ™‚å€™ï¼Œç™¼ç¾æ²’æœ‰ GCLB é€™å€‹ cookieã€‚\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: socket-ingress annotations: kubernetes.io/ingress.class: \u0026#34;gce\u0026#34; spec: rules: - host: socket.example.com http: paths: - path: / pathType: Prefix backend: service: name: socket-service port: number: 80 éƒ½å»ºç«‹å®Œæˆä»¥å¾Œï¼Œå¯ä»¥é€éä»¥ä¸‹æ–¹å¼é€²è¡Œæ¸¬è©¦\ncurl -i -X GET http://socket.example.com å•é¡Œåæ€ # é€™æ¬¡çš„å¯¦ä½œéç¨‹ä¸­ï¼Œé›–ç„¶é€™ç¨®æ–¹å¼çœ‹ä¼¼å¯ä»¥ä¿æŒå®¢æˆ¶ç«¯èˆ‡åŒä¸€ä¼ºæœå™¨çš„é€£çµã€‚ä½†å› ç‚ºæ˜¯èŠå¤©å®¤æœå‹™ï¼Œå¯èƒ½é‚„æ˜¯æœƒæœ‰ä¸€äº›å•é¡Œéœ€è¦æ³¨æ„ï¼š\nâ­ï¸ session è¦ªå’Œæ€§åªæ˜¯ç›¡å¯èƒ½ä¿æŒé€£æ¥åœ¨åŒä¸€ä¼ºæœå™¨ï¼Œä½†ç„¡æ³•ä¿è­‰ 100% çš„ç©©å®šæ€§ã€‚å¦‚æœç¬¬ä¸€æ¬¡é€£ç·šæ˜¯é€£åˆ° A ä¼ºæœå™¨ï¼Œä¹‹å¾Œå› ç‚ºæŸäº›åŸå› ï¼ˆå¦‚ä¼ºæœå™¨é‡å•Ÿã€è² è¼‰å‡è¡¡ç­–ç•¥è®Šæ›´ç­‰ï¼‰å¯èƒ½æœƒè¢«å°å‘ B ä¼ºæœå™¨ï¼Œé€™æ¨£å°±æœƒå°è‡´ç”¨æˆ¶é«”é©—ä¸ä¸€è‡´ã€‚\nä¸‹é¢æ˜¯è·Ÿä¸€ä½åŒä»è¨è«–ä¹‹å¾Œç´€éŒ„ä¸‹ä¾†çš„ç°¡æ˜“æ¶æ§‹åœ–ï¼š\nclient ç«¯åœ¨ä¸€é–‹å§‹é€£ç·šçš„æ™‚å€™ï¼Œå°±æ˜¯ä¸åŒçš„ socket_server client ç«¯åŒæ™‚ä¹Ÿæœƒé€é api å° MQ æˆ–è€… Pub/Sub é€²è¡Œè¨Šæ¯çš„ç™¼é€ã€‚ server ç«¯å¯ä»¥ä¾æ“š channel é€²è¡Œè¨Šæ¯çš„è·¯ç”±ã€‚åŒæ­¥çµ¦åœ¨ä¸åŒ socket_server çš„ clientã€‚ flowchart client01 client02 MQ/Pub_Sub socket_server01 socket_server02 client01 --channel,msg--\u003e MQ/Pub_Sub client02 --channel,msg--\u003e MQ/Pub_Sub MQ/Pub_Sub --\u003e socket_server01 MQ/Pub_Sub --\u003e socket_server02 socket_server01 \u003c--\u003e client01 socket_server02 \u003c--\u003e client02 åƒè€ƒè³‡æ–™ # åœ¨ GCP/GKE çš„ Ingress è¨­å®š sticky session é€éç¨ç«‹çš„å€åŸŸ NEG ä½¿ç”¨å®¹å™¨åŸç”Ÿè² è¼‰å¹³è¡¡ ","externalUrl":null,"permalink":"/journals/k8s/sticky-session/","section":"Journals","summary":"å‰è¨€ # è¿‘æœŸå…¬å¸æœ‰ socket.","title":"sticky session in kubernetes","type":"journals"}]